{"version":3,"sources":["kernels/simulation.ts","simulator.ts","serialization.ts","sources.ts","share.ts","components.tsx","maps.ts","util.ts","kernels/rendering.ts","App.tsx","serviceWorker.ts","index.tsx","icons/fullscreen.png"],"names":["getAt","field","shapeX","shapeY","x","y","makeFieldTexture","value","copyTexture","texture","this","thread","copyTextureWithBounds","bounds","outOfBoundsValue","drawSquare","pos","size","keep","oldValue","output","Math","max","abs","drawCircle","radius","dx","dy","injectSource","source","dt","gx","gy","decaySource","pow","updateMagneticX","fieldY","fieldZ","permeability","magFieldX","cs","reflectiveBoundary","xAtMinBound","xAtMaxBound","yAtMinBound","yAtMaxBound","updateMagneticY","fieldX","magFieldY","updateMagneticZ","magFieldZ","updateElectricX","permittivity","elFieldX","updateElectricY","elFieldY","updateElectricZ","elFieldZ","makeDrawSquareInfo","center","halfSize","drawShape","makeDrawCircleInfo","memoByName","makeNew","memoized","name","FDTDSimulator","gpu","gridSize","cellSize","data","updateMagnetic","updateElectric","drawOnTexture","kernels","setGridSize","forEach","kernel","setOutput","dim","electricField","shape","magneticField","oldShape","values","resetFields","setCellSize","stepElectric","el","map","f","mag","perm","injectedElZ","electricSourceFieldZ","time","stepMagnetic","resetMaterials","fieldName","drawInfo","drawFunc","copiedValues","Error","JSON","stringify","drawMaterial","materialType","materialField","injectSignal","loadPermittivity","length","loadPermeability","getData","makeKernel","runKernel","createKernel","setWarnVarUsage","setPipeline","setTactic","setDynamicOutput","setDynamicArguments","setPrecision","push","makeKernelWithFuncs","setFunctions","k","makeKernelWithFuncsAndConsts","setConstants","makeField","initialValue","i","encodeSimulatorMap","simulatorMap","simulationSettings","sourceDescriptors","encodedMaterialMap","encodeMaterialMap","materialMap","decodeSimulatorMap","encodedSimulatorMap","decodeMaterialMap","materialMapArray","Float32Array","index","pako","Uint8Array","buffer","to","PointSignalSource","amplitude","frequency","position","turnOffTime","inject","simulator","t","undefined","cos","PI","apiUrl","shareId","a","fetch","response","ok","text","responseText","parse","method","mode","headers","body","json","responseObject","CollapsibleContainer","props","useState","initiallyCollapsed","collapsed","setCollapsed","id","className","style","textAlign","background","fontWeight","color","onClick","e","width","height","border","cursor","buttonStyle","title","children","LabeledSlider","setValue","allowNegative","logarithmic","displayDigits","absValue","log2","negative","setNegative","rangeSliderRef","useRef","updateValue","useCallback","current","newValue","parseFloat","useEffect","displayValue","toFixed","label","marginLeft","type","checked","onChange","target","ref","min","step","lineHeight","marginBottom","OptionSelector","options","option","optionIndex","key","backgroundColor","selectedOption","overflow","textOverflow","setSelectedOption","SaveLoadComponent","setShareId","materialMapUrl","setMaterialMapUrl","getMaterialMap","useMemo","simData","toArray","onSaveClicked","window","open","onLoadClicked","onGenerateShareUrlClicked","shareSimulatorMap","simulationSpeed","then","catch","err","console","log","shareUrl","location","origin","pathname","shareUrlTextRef","onCopyClicked","select","document","execCommand","share","nav","navigator","onShareClicked","url","error","padding","paddingTop","fontSize","margin","readOnly","marginTop","ExamplesComponent","setGridSizeLongest","setDt","setSimulationSpeed","setSources","loadMap","loadedSources","desc","_","Array","fill","maps","slitCenterX","round","slitSize","isWallRow","permittivityRow","getCurvePoint","sin","thickness","endPoint","isLensPoint","point","SettingsComponent","qualityPresets","setResolutionScale","onPresetClicked","preset","gridSizeLongest","resolutionScale","Object","keys","presetName","setReflectiveBoundary","ControlComponent","showSignal","clickOption","drawShapeType","setDrawShapeType","drawShapeTypeIndex","setDrawShapeTypeIndex","brushSizeLabel","snapInput","setSnapInput","display","signalBrushSize","setSignalBrushSize","signalBrushValue","setSignalBrushValue","signalFrequency","setSignalFrequency","materialBrushSize","setMaterialBrushSize","permittivityBrushValue","setPermittivityBrushValue","permeabilityBrushValue","setPermeabilityBrushValue","setClickOption","toggleFullScreen","fullscreenElement","exitFullscreen","documentElement","requestFullscreen","clamp","drawGpu","electricFieldX","electricFieldY","electricFieldZ","magneticFieldX","magneticFieldY","magneticFieldZ","fieldBrightness","eX","eY","eZ","eAA","mX","mY","mZ","mAA","permittivityValue","exp","permeabilityValue","tileFactorX","tileFactorY","backgroundX","backgroundY","drawCpu","fx","fy","gpuMode","GPU","isSinglePrecisionSupported","isWebGL2Supported","isWebGLSupported","getGpuMode","defaultPreset","defaultSignalFrequency","initialDt","initialCellSize","initialGridSizeLongest","initialResolutionScale","initialWindowSize","innerWidth","innerHeight","initialCanvasSize","calculateCanvasSize","initialGridSize","calculateGridSize","windowSize","canvasSize","canvasAspect","ceil","Boolean","hostname","match","ReactDOM","render","urlShareId","hash","substr","drawCanvasRef","setCanvasSize","setWindowSize","sources","adjustCanvasSize","wndSize","addEventListener","removeEventListener","setGpu","canvas","renderSim","setGraphical","makeRenderSimulatorCanvas","getSharedSimulatorMap","drawingMaterial","setDrawingMaterial","mousePosition","setMousePosition","signalStrength","mouseDownPos","inputStartPos","setInputStartPos","inputDir","setInputDir","windowToSimulationPoint","windowPoint","floor","simStep","brushHalfSize","timer","setInterval","clearInterval","drawStep","cnvSize","stop","requestAnimationFrame","drawIfNotStopped","changeMaterial","canvasPos","onInputDown","clientPos","onInputMove","shiftDown","offset","projection","angleQuantum","snappedAngle","atan2","dir","onInputUp","activeBrushSize","touchAction","userSelect","onMouseDown","clientX","clientY","onMouseMove","shiftKey","onMouseUp","onMouseLeave","onTouchStart","touches","onTouchMove","onTouchEnd","onTouchCancel","onContextMenu","preventDefault","bottom","right","href","rel","textDecoration","marginRight","pointerEvents","left","top","borderRadius","src","Fullscreen","alt","getElementById","serviceWorker","ready","registration","unregister","module","exports"],"mappings":"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","file":"static/js/main.5c314598.chunk.js","sourcesContent":["import { IKernelFunctionThis } from \"gpu.js\"\r\n\r\nexport function getAt(field: number[][], shapeX: number, shapeY: number, x: number, y: number) {\r\n    if (x < 0 || x >= shapeX || y < 0 || y >= shapeY) {\r\n        return 0\r\n    }\r\n\r\n    return field[y][x]\r\n}\r\n\r\nexport function makeFieldTexture(this: IKernelFunctionThis, value: number) {\r\n    return value\r\n}\r\n\r\nexport function copyTexture(this: IKernelFunctionThis, texture: number[][]) {\r\n    return texture[this.thread.y!][this.thread.x]\r\n}\r\n\r\nexport function copyTextureWithBounds(this: IKernelFunctionThis, texture: number[][], bounds: number[], outOfBoundsValue: number) {\r\n    const x = this.thread.x as number\r\n    const y = this.thread.y! as number\r\n\r\n    if (x < 0 || y < 0 || x >= bounds[0] || y >= bounds[1]) {\r\n        return outOfBoundsValue\r\n    }\r\n\r\n    return texture[y][x]\r\n}\r\n\r\nexport function drawSquare(this: IKernelFunctionThis, pos: number[], size: number, value: number, keep: number, texture: number[][]) {\r\n    const x = this.thread.x as number\r\n    const y = this.thread.y! as number\r\n    const gx = this.output.x as number\r\n    const gy = this.output.y as number\r\n\r\n    const oldValue = getAt(texture, gx, gy, x, y)\r\n\r\n    const within = Math.max(Math.abs(pos[0] - x), Math.abs(pos[1] - y)) < size\r\n\r\n    return within ? value + keep * oldValue : oldValue\r\n}\r\n\r\nexport function drawCircle(this: IKernelFunctionThis, pos: number[], radius: number, value: number, keep: number, texture: number[][]) {\r\n    const x = this.thread.x as number\r\n    const y = this.thread.y! as number\r\n    const gx = this.output.x as number\r\n    const gy = this.output.y as number\r\n\r\n    const oldValue = getAt(texture, gx, gy, x, y)\r\n\r\n    const dx = pos[0] - x\r\n    const dy = pos[1] - y\r\n\r\n    const within = dx * dx + dy * dy < radius * radius\r\n\r\n    return within ? value + keep * oldValue : oldValue\r\n}\r\n\r\nexport function injectSource(this: IKernelFunctionThis, source: number[][], field: number[][], dt: number) {\r\n    const x = this.thread.x as number\r\n    const y = this.thread.y! as number\r\n    const gx = this.output.x as number\r\n    const gy = this.output.y as number\r\n\r\n    return getAt(field, gx, gy, x, y) + getAt(source, gx, gy, x, y) * dt\r\n}\r\n\r\nexport function decaySource(this: IKernelFunctionThis, source: number[][], dt: number) {\r\n    const x = this.thread.x as number\r\n    const y = this.thread.y! as number\r\n    const gx = this.output.x as number\r\n    const gy = this.output.y as number\r\n\r\n    return getAt(source, gx, gy, x, y) * Math.pow(0.1, dt)\r\n}\r\n\r\nexport function updateMagneticX(this: IKernelFunctionThis, fieldY: number[][], fieldZ: number[][], permeability: number[][], magFieldX: number[][], dt: number, cs: number, reflectiveBoundary: boolean) {\r\n    const x = this.thread.x as number\r\n    const y = this.thread.y! as number\r\n    const gx = this.output.x as number\r\n    const gy = this.output.y as number\r\n\r\n    if (!reflectiveBoundary) {\r\n        const xAtMinBound = x < 2 ? 1 : 0\r\n        const xAtMaxBound = x + 2 >= gx ? -1 : 0\r\n        const yAtMinBound = y < 2 ? 1 : 0\r\n        const yAtMaxBound = y + 2 >= gy ? -1 : 0\r\n        if (xAtMinBound !== 0 || xAtMaxBound !== 0 || yAtMinBound !== 0 || yAtMaxBound !== 0) {\r\n            return magFieldX[y + yAtMinBound + yAtMaxBound][x + xAtMinBound + xAtMaxBound]\r\n        }\r\n    }\r\n\r\n    // d_Y Z - d_Z Y\r\n    return getAt(magFieldX, gx, gy, x, y) - (dt / (getAt(permeability, gx, gy, x, y) * cs)) * (\r\n        (getAt(fieldZ, gx, gy, x, y + 1) - getAt(fieldZ, gx, gy, x, y)))\r\n}\r\n\r\nexport function updateMagneticY(this: IKernelFunctionThis, fieldX: number[][], fieldZ: number[][], permeability: number[][], magFieldY: number[][], dt: number, cs: number, reflectiveBoundary: boolean) {\r\n    const x = this.thread.x as number\r\n    const y = this.thread.y! as number\r\n    const gx = this.output.x as number\r\n    const gy = this.output.y as number\r\n\r\n    if (!reflectiveBoundary) {\r\n        const xAtMinBound = x < 2 ? 1 : 0\r\n        const xAtMaxBound = x + 2 >= gx ? -1 : 0\r\n        const yAtMinBound = y < 2 ? 1 : 0\r\n        const yAtMaxBound = y + 2 >= gy ? -1 : 0\r\n        if (xAtMinBound !== 0 || xAtMaxBound !== 0 || yAtMinBound !== 0 || yAtMaxBound !== 0) {\r\n            return magFieldY[y + yAtMinBound + yAtMaxBound][x + xAtMinBound + xAtMaxBound]\r\n        }\r\n    }\r\n\r\n    // d_Z X - d_X Z\r\n    return getAt(magFieldY, gx, gy, x, y) - (dt / (getAt(permeability, gx, gy, x, y) * cs)) * (\r\n        -(getAt(fieldZ, gx, gy, x + 1, y) - getAt(fieldZ, gx, gy, x, y)))\r\n}\r\n\r\nexport function updateMagneticZ(this: IKernelFunctionThis, fieldX: number[][], fieldY: number[][], permeability: number[][], magFieldZ: number[][], dt: number, cs: number, reflectiveBoundary: boolean) {\r\n    const x = this.thread.x as number\r\n    const y = this.thread.y! as number\r\n    const gx = this.output.x as number\r\n    const gy = this.output.y as number\r\n\r\n    if (!reflectiveBoundary) {\r\n        const xAtMinBound = x < 2 ? 1 : 0\r\n        const xAtMaxBound = x + 2 >= gx ? -1 : 0\r\n        const yAtMinBound = y < 2 ? 1 : 0\r\n        const yAtMaxBound = y + 2 >= gy ? -1 : 0\r\n        if (xAtMinBound !== 0 || xAtMaxBound !== 0 || yAtMinBound !== 0 || yAtMaxBound !== 0) {\r\n            return magFieldZ[y + yAtMinBound + yAtMaxBound][x + xAtMinBound + xAtMaxBound]\r\n        }\r\n    }\r\n\r\n    // d_X Y - d_Y X\r\n    return getAt(magFieldZ, gx, gy, x, y) - (dt / (getAt(permeability, gx, gy, x, y) * cs)) * (\r\n        (getAt(fieldY, gx, gy, x + 1, y) - getAt(fieldY, gx, gy, x, y)) -\r\n        (getAt(fieldX, gx, gy, x, y + 1) - getAt(fieldX, gx, gy, x, y)))\r\n}\r\n\r\nexport function updateElectricX(this: IKernelFunctionThis, fieldY: number[][], fieldZ: number[][], permittivity: number[][], elFieldX: number[][], dt: number, cs: number, reflectiveBoundary: boolean) {\r\n    const x = this.thread.x as number\r\n    const y = this.thread.y! as number\r\n    const gx = this.output.x as number\r\n    const gy = this.output.y as number\r\n\r\n    if (!reflectiveBoundary) {\r\n        const xAtMinBound = x < 2 ? 1 : 0\r\n        const xAtMaxBound = x + 2 >= gx ? -1 : 0\r\n        const yAtMinBound = y < 2 ? 1 : 0\r\n        const yAtMaxBound = y + 2 >= gy ? -1 : 0\r\n        if (xAtMinBound !== 0 || xAtMaxBound !== 0 || yAtMinBound !== 0 || yAtMaxBound !== 0) {\r\n            return elFieldX[y + yAtMinBound + yAtMaxBound][x + xAtMinBound + xAtMaxBound]\r\n        }\r\n    }\r\n\r\n    // d_Y Z - d_Z Y\r\n    return getAt(elFieldX, gx, gy, x, y) + (dt / (getAt(permittivity, gx, gy, x, y) * cs)) * (\r\n        (getAt(fieldZ, gx, gy, x, y) - getAt(fieldZ, gx, gy, x, y - 1)))\r\n}\r\n\r\nexport function updateElectricY(this: IKernelFunctionThis, fieldX: number[][], fieldZ: number[][], permittivity: number[][], elFieldY: number[][], dt: number, cs: number, reflectiveBoundary: boolean) {\r\n    const x = this.thread.x as number\r\n    const y = this.thread.y! as number\r\n    const gx = this.output.x as number\r\n    const gy = this.output.y as number\r\n\r\n    if (!reflectiveBoundary) {\r\n        const xAtMinBound = x < 2 ? 1 : 0\r\n        const xAtMaxBound = x + 2 >= gx ? -1 : 0\r\n        const yAtMinBound = y < 2 ? 1 : 0\r\n        const yAtMaxBound = y + 2 >= gy ? -1 : 0\r\n        if (xAtMinBound !== 0 || xAtMaxBound !== 0 || yAtMinBound !== 0 || yAtMaxBound !== 0) {\r\n            return elFieldY[y + yAtMinBound + yAtMaxBound][x + xAtMinBound + xAtMaxBound]\r\n        }\r\n    }\r\n\r\n    // d_Z X - d_X Z\r\n    return getAt(elFieldY, gx, gy, x, y) + (dt / (getAt(permittivity, gx, gy, x, y) * cs)) * (\r\n        -(getAt(fieldZ, gx, gy, x, y) - getAt(fieldZ, gx, gy, x - 1, y)))\r\n}\r\n\r\nexport function updateElectricZ(this: IKernelFunctionThis, fieldX: number[][], fieldY: number[][], permittivity: number[][], elFieldZ: number[][], dt: number, cs: number, reflectiveBoundary: boolean) {\r\n    const x = this.thread.x as number\r\n    const y = this.thread.y! as number\r\n    const gx = this.output.x as number\r\n    const gy = this.output.y as number\r\n\r\n    if (!reflectiveBoundary) {\r\n        const xAtMinBound = x < 2 ? 1 : 0\r\n        const xAtMaxBound = x + 2 >= gx ? -1 : 0\r\n        const yAtMinBound = y < 2 ? 1 : 0\r\n        const yAtMaxBound = y + 2 >= gy ? -1 : 0\r\n        if (xAtMinBound !== 0 || xAtMaxBound !== 0 || yAtMinBound !== 0 || yAtMaxBound !== 0) {\r\n            return elFieldZ[y + yAtMinBound + yAtMaxBound][x + xAtMinBound + xAtMaxBound]\r\n        }\r\n    }\r\n\r\n    // d_X Y - d_Y X\r\n    return getAt(elFieldZ, gx, gy, x, y) + (dt / (getAt(permittivity, gx, gy, x, y) * cs)) * (\r\n        (getAt(fieldY, gx, gy, x, y) - getAt(fieldY, gx, gy, x - 1, y)) -\r\n        (getAt(fieldX, gx, gy, x, y) - getAt(fieldX, gx, gy, x, y - 1)))\r\n}","import { GPU, IKernelRunShortcut, Texture, KernelFunction } from \"gpu.js\"\r\nimport * as k from \"./kernels/simulation\"\r\n\r\nexport type MaterialType = \"permittivity\" | \"permeability\"\r\n\r\nexport type DrawShapeType = \"square\" | \"circle\"\r\n\r\ntype BaseDrawInfo = {\r\n    drawShape: DrawShapeType\r\n    center: [number, number]\r\n    value: number\r\n}\r\n\r\ntype DrawSquareInfo = {\r\n    drawShape: \"square\"\r\n    halfSize: number\r\n} & BaseDrawInfo\r\n\r\ntype DrawCircleInfo = {\r\n    drawShape: \"circle\"\r\n    radius: number\r\n} & BaseDrawInfo\r\n\r\nexport function makeDrawSquareInfo(center: [number, number], halfSize: number, value: number): DrawSquareInfo {\r\n    return {\r\n        drawShape: \"square\",\r\n        center,\r\n        halfSize: halfSize,\r\n        value\r\n    }\r\n}\r\n\r\nexport function makeDrawCircleInfo(center: [number, number], radius: number, value: number): DrawCircleInfo {\r\n    return {\r\n        drawShape: \"circle\",\r\n        center,\r\n        radius,\r\n        value\r\n    }\r\n}\r\n\r\nexport type DrawInfo = DrawSquareInfo | DrawCircleInfo\r\n\r\nexport type ScalarField2D = {\r\n    values: Texture\r\n    shape: [number, number]\r\n}\r\n\r\nexport type SimulationData = {\r\n    time: number\r\n    electricField: [ScalarField2D, ScalarField2D, ScalarField2D]\r\n    magneticField: [ScalarField2D, ScalarField2D, ScalarField2D]\r\n\r\n    permittivity: ScalarField2D\r\n    permeability: ScalarField2D\r\n\r\n    electricSourceFieldZ: ScalarField2D\r\n}\r\n\r\nexport interface Simulator {\r\n    stepElectric: (dt: number) => void\r\n    stepMagnetic: (dt: number) => void\r\n    resetFields: () => void\r\n    resetMaterials: () => void\r\n    injectSignal: (drawInfo: DrawInfo, dt: number) => void\r\n    getData: () => SimulationData\r\n}\r\n\r\nfunction memoByName<T>(makeNew: () => T) {\r\n    const memoized: { [name: string]: T } = {}\r\n\r\n    return (name: string) => {\r\n        if (!memoized[name]) {\r\n            memoized[name] = makeNew()\r\n        }\r\n        return memoized[name]\r\n    }\r\n}\r\n\r\nexport class FDTDSimulator implements Simulator {\r\n    private data: SimulationData\r\n\r\n    private updateMagnetic: [IKernelRunShortcut, IKernelRunShortcut, IKernelRunShortcut]\r\n    private updateElectric: [IKernelRunShortcut, IKernelRunShortcut, IKernelRunShortcut]\r\n\r\n    private injectSource: IKernelRunShortcut\r\n    private decaySource: IKernelRunShortcut\r\n\r\n    private makeFieldTexture: (name: string) => IKernelRunShortcut\r\n    private copyTexture: (name: string) => IKernelRunShortcut\r\n    private copyTextureWithBounds: (name: string) => IKernelRunShortcut\r\n\r\n    private drawOnTexture: { [shape: string]: (name: string) => IKernelRunShortcut }\r\n\r\n    private kernels: IKernelRunShortcut[] = []\r\n\r\n    constructor(readonly gpu: GPU, private gridSize: [number, number], private cellSize: number, public reflectiveBoundary: boolean) {\r\n        const makeKernel = (kernel: KernelFunction) => {\r\n            const runKernel = this.gpu.createKernel(kernel).setOutput(this.gridSize).setWarnVarUsage(false)\r\n                .setPipeline(true).setTactic(\"performance\").setDynamicOutput(true).setDynamicArguments(true).setPrecision(\"single\")\r\n            this.kernels.push(runKernel)\r\n            return runKernel\r\n        }\r\n        const makeKernelWithFuncs = (kernel: KernelFunction) => makeKernel(kernel).setFunctions([k.getAt])\r\n        const makeKernelWithFuncsAndConsts = (kernel: KernelFunction) => makeKernelWithFuncs(kernel).setConstants({ cellSize: cellSize })\r\n\r\n        this.makeFieldTexture = memoByName(() => makeKernel(k.makeFieldTexture))\r\n        this.copyTexture = memoByName(() => makeKernel(k.copyTexture))\r\n        this.copyTextureWithBounds = memoByName(() => makeKernel(k.copyTextureWithBounds))\r\n\r\n        const makeField = (name: string, initialValue: number): ScalarField2D => { return { values: this.makeFieldTexture(name)(initialValue) as Texture, shape: this.gridSize } }\r\n\r\n        this.data = {\r\n            time: 0,\r\n            electricField: [0, 1, 2].map(i => makeField(`e${i}`, 0)) as [ScalarField2D, ScalarField2D, ScalarField2D],\r\n            magneticField: [0, 1, 2].map(i => makeField(`m${i}`, 0)) as [ScalarField2D, ScalarField2D, ScalarField2D],\r\n            electricSourceFieldZ: makeField(\"es2\", 0),\r\n            permittivity: makeField(\"permittivity\", 1),\r\n            permeability: makeField(\"permeability\", 1)\r\n        }\r\n\r\n        this.drawOnTexture = {\r\n            \"square\": memoByName(() => makeKernelWithFuncsAndConsts(k.drawSquare)),\r\n            \"circle\": memoByName(() => makeKernelWithFuncsAndConsts(k.drawCircle))\r\n        }\r\n\r\n        this.injectSource = makeKernelWithFuncs(k.injectSource)\r\n        this.decaySource = makeKernelWithFuncs(k.decaySource)\r\n\r\n        this.updateMagnetic = [\r\n            makeKernelWithFuncsAndConsts(k.updateMagneticX),\r\n            makeKernelWithFuncsAndConsts(k.updateMagneticY),\r\n            makeKernelWithFuncsAndConsts(k.updateMagneticZ)\r\n        ]\r\n\r\n        this.updateElectric = [\r\n            makeKernelWithFuncsAndConsts(k.updateElectricX),\r\n            makeKernelWithFuncsAndConsts(k.updateElectricY),\r\n            makeKernelWithFuncsAndConsts(k.updateElectricZ)\r\n        ]\r\n    }\r\n\r\n    setGridSize = (gridSize: [number, number]) => {\r\n        this.gridSize = gridSize\r\n\r\n        this.kernels.forEach(kernel => kernel.setOutput(gridSize))\r\n\r\n        for (let dim = 0; dim < 3; dim++) {\r\n            this.data.electricField[dim].shape = gridSize\r\n            this.data.magneticField[dim].shape = gridSize\r\n        }\r\n\r\n        const oldShape = this.data.permittivity.shape\r\n\r\n        this.data.permittivity.shape = gridSize\r\n        this.data.permeability.shape = gridSize\r\n\r\n        this.data.permittivity.values = this.copyTextureWithBounds(\"permittivity\")(this.data.permittivity.values, oldShape, 1) as Texture\r\n        this.data.permeability.values = this.copyTextureWithBounds(\"permeability\")(this.data.permeability.values, oldShape, 1) as Texture\r\n\r\n        this.resetFields()\r\n    }\r\n\r\n    setCellSize = (cellSize: number) => {\r\n        this.cellSize = cellSize\r\n\r\n        this.resetFields()\r\n    }\r\n\r\n    stepElectric = (dt: number) => {\r\n        const el = this.data.electricField.map(f => f.values)\r\n        const mag = this.data.magneticField.map(f => f.values)\r\n        const perm = this.data.permittivity.values\r\n\r\n        const injectedElZ = this.injectSource(this.data.electricSourceFieldZ.values, el[2], dt) as Texture\r\n        this.data.electricSourceFieldZ.values = this.decaySource(this.copyTexture(\"es2\")(this.data.electricSourceFieldZ.values), dt) as Texture\r\n\r\n        // d/dt E(x, t) = curl B(x, t) / \r\n        this.data.electricField[0].values = this.updateElectric[0](mag[1], mag[2], perm, this.copyTexture(\"e0\")(el[0]), dt, this.cellSize, this.reflectiveBoundary) as Texture\r\n        this.data.electricField[1].values = this.updateElectric[1](mag[0], mag[2], perm, this.copyTexture(\"e1\")(el[1]), dt, this.cellSize, this.reflectiveBoundary) as Texture\r\n        this.data.electricField[2].values = this.updateElectric[2](mag[0], mag[1], perm, injectedElZ, dt, this.cellSize, this.reflectiveBoundary) as Texture\r\n\r\n        this.data.time += dt / 2\r\n    }\r\n\r\n    stepMagnetic = (dt: number) => {\r\n        const el = this.data.electricField.map(f => f.values)\r\n        const mag = this.data.magneticField.map(f => f.values)\r\n        const perm = this.data.permeability.values\r\n\r\n        // d/dt B(x, t) = -curl E(x, t) / \r\n        this.data.magneticField[0].values = this.updateMagnetic[0](el[1], el[2], perm, this.copyTexture(\"m0\")(mag[0]), dt, this.cellSize, this.reflectiveBoundary) as Texture\r\n        this.data.magneticField[1].values = this.updateMagnetic[1](el[0], el[2], perm, this.copyTexture(\"m1\")(mag[1]), dt, this.cellSize, this.reflectiveBoundary) as Texture\r\n        this.data.magneticField[2].values = this.updateMagnetic[2](el[0], el[1], perm, this.copyTexture(\"m2\")(mag[2]), dt, this.cellSize, this.reflectiveBoundary) as Texture\r\n\r\n        this.data.time += dt / 2\r\n    }\r\n\r\n    resetFields = () => {\r\n        this.data.time = 0\r\n\r\n        for (let dim = 0; dim < 3; dim++) {\r\n            this.data.electricField[dim].values = this.makeFieldTexture(`e${dim}`)(0) as Texture\r\n            this.data.magneticField[dim].values = this.makeFieldTexture(`m${dim}`)(0) as Texture\r\n        }\r\n\r\n        this.data.electricSourceFieldZ.values = this.makeFieldTexture(\"es2\")(0) as Texture\r\n    }\r\n\r\n    resetMaterials = () => {\r\n        this.data.permeability.values = this.makeFieldTexture(\"permeability\")(1) as Texture\r\n        this.data.permittivity.values = this.makeFieldTexture(\"permittivity\")(1) as Texture\r\n    }\r\n\r\n    private drawShape = (field: ScalarField2D, fieldName: string, drawInfo: DrawInfo, keep: number) => {\r\n        const drawFunc = this.drawOnTexture[drawInfo.drawShape](fieldName)\r\n        const copiedValues = this.copyTexture(fieldName)(field.values)\r\n\r\n        switch (drawInfo.drawShape) {\r\n            case \"square\":\r\n                field.values = drawFunc(drawInfo.center, drawInfo.halfSize, drawInfo.value, keep, copiedValues) as Texture\r\n                break\r\n            case \"circle\":\r\n                field.values = drawFunc(drawInfo.center, drawInfo.radius, drawInfo.value, keep, copiedValues) as Texture\r\n                break\r\n            default:\r\n                throw Error(`Invalid draw shape: ${JSON.stringify(drawInfo)}`)\r\n        }\r\n    }\r\n\r\n    drawMaterial = (materialType: MaterialType, drawInfo: DrawInfo) => {\r\n        const materialField = materialType === \"permeability\" ? this.data.permeability : this.data.permittivity\r\n        this.drawShape(materialField, materialType, drawInfo, 0)\r\n    }\r\n\r\n    injectSignal = (drawInfo: DrawInfo, dt: number) => {\r\n        this.drawShape(this.data.electricSourceFieldZ, \"es2\", {...drawInfo, value: drawInfo.value * dt}, 1)\r\n    }\r\n\r\n    loadPermittivity = (permittivity: number[][]) => {\r\n        this.data.permittivity.values = this.copyTextureWithBounds(\"loadPermittivity\")(permittivity, [permittivity[0].length, permittivity.length], 1) as Texture\r\n    }\r\n\r\n    loadPermeability = (permeability: number[][]) => {\r\n        this.data.permeability.values = this.copyTextureWithBounds(\"loadPermeability\")(permeability, [permeability[0].length, permeability.length], 1) as Texture\r\n    }\r\n\r\n    getData = () => this.data\r\n}","import * as pako from \"pako\"\r\n\r\nexport type SimulationSettings = {\r\n    dt: number\r\n    gridSize: [number, number]\r\n    simulationSpeed: number\r\n    cellSize: number\r\n}\r\n\r\nexport type MaterialMap = {\r\n    permittivity: number[][]\r\n    permeability: number[][]\r\n    shape: [number, number]\r\n}\r\n\r\nexport type EncodedMaterialMap = string\r\n\r\nexport type SourceDescriptor = {\r\n    type: \"point\"\r\n    position: [number, number]\r\n    amplitude: number\r\n    frequency: number\r\n    turnOffTime?: number\r\n}\r\n\r\nexport type SimulatorMap = {\r\n    materialMap: MaterialMap\r\n    simulationSettings: SimulationSettings\r\n    sourceDescriptors: SourceDescriptor[]\r\n}\r\n\r\nexport type EncodedSimulatorMap = {\r\n    encodedMaterialMap: string\r\n    simulationSettings: SimulationSettings\r\n    sourceDescriptors: SourceDescriptor[]\r\n}\r\n\r\nexport function encodeSimulatorMap(simulatorMap: SimulatorMap): EncodedSimulatorMap {\r\n    return {\r\n        simulationSettings: simulatorMap.simulationSettings,\r\n        sourceDescriptors: simulatorMap.sourceDescriptors,\r\n        encodedMaterialMap: encodeMaterialMap(simulatorMap.materialMap)\r\n    }\r\n}\r\n\r\nexport function decodeSimulatorMap(encodedSimulatorMap: EncodedSimulatorMap): SimulatorMap {\r\n    const materialMap = decodeMaterialMap(encodedSimulatorMap.encodedMaterialMap)\r\n\r\n    return {\r\n        simulationSettings: encodedSimulatorMap.simulationSettings,\r\n        sourceDescriptors: encodedSimulatorMap.sourceDescriptors,\r\n        materialMap: materialMap\r\n    }\r\n}\r\n\r\nexport function encodeMaterialMap(materialMap: MaterialMap): string {\r\n    const materialMapArray = new Float32Array(2 + 2 * materialMap.shape[0] * materialMap.shape[1])\r\n\r\n    materialMapArray[0] = materialMap.shape[0]\r\n    materialMapArray[1] = materialMap.shape[1]\r\n\r\n    for (let y = 0; y < materialMap.shape[1]; y++) {\r\n        for (let x = 0; x < materialMap.shape[0]; x++) {\r\n            const index = y * materialMap.shape[0] * 2 + x * 2\r\n            materialMapArray[2 + index] = materialMap.permittivity[y][x]\r\n            materialMapArray[2 + index + 1] = materialMap.permeability[y][x]\r\n        }\r\n    }\r\n\r\n    const encodedMaterialMap: EncodedMaterialMap = pako.deflate(new Uint8Array(materialMapArray.buffer), { to: \"string\" })\r\n    return encodedMaterialMap\r\n}\r\n\r\nexport function decodeMaterialMap(encodedMaterialMap: EncodedMaterialMap): MaterialMap {\r\n    const materialMapArray = new Float32Array(pako.inflate(encodedMaterialMap).buffer)\r\n    const shape: [number, number] = [materialMapArray[0], materialMapArray[1]]\r\n\r\n    const permittivity: number[][] = []\r\n    const permeability: number[][] = []\r\n\r\n    for (let y = 0; y < shape[1]; y++) {\r\n        permittivity.push([])\r\n        permeability.push([])\r\n        for (let x = 0; x < shape[0]; x++) {\r\n            const index = y * shape[0] * 2 + x * 2\r\n            permittivity[y].push(materialMapArray[2 + index])\r\n            permeability[y].push(materialMapArray[2 + index + 1])\r\n        }\r\n    }\r\n\r\n    return {\r\n        shape: shape,\r\n        permittivity: permittivity,\r\n        permeability: permeability\r\n    }\r\n}","import { Simulator, makeDrawSquareInfo } from \"./simulator\"\r\n\r\nexport interface SignalSource {\r\n    inject(simulator: Simulator, dt: number): void\r\n}\r\n\r\nexport class PointSignalSource implements SignalSource {\r\n    constructor(public amplitude: number, public frequency: number, public position: [number, number], public turnOffTime?: number) {\r\n\r\n    }\r\n\r\n    inject = (simulator: Simulator, dt: number) => {\r\n        const t = simulator.getData().time\r\n        if (t >= 0 && (this.turnOffTime === undefined || t <= this.turnOffTime)) {\r\n            const amplitude = -this.amplitude * Math.cos(2 * Math.PI * this.frequency * t)\r\n            const drawInfo = makeDrawSquareInfo(this.position, 1, amplitude)\r\n            simulator.injectSignal(drawInfo, dt)\r\n        }\r\n    }\r\n}\r\n\r\n","import { EncodedSimulatorMap, decodeSimulatorMap, SimulatorMap, encodeSimulatorMap } from \"./serialization\"\r\n\r\nconst apiUrl = \"https://6xuthl3lv4.execute-api.us-east-1.amazonaws.com/live/share\"\r\n\r\nexport async function getSharedSimulatorMap(shareId: string): Promise<SimulatorMap> {\r\n    const response = await fetch(`${apiUrl}?shareId=${shareId}`)\r\n\r\n    if (response.ok) {\r\n        const responseText = await response.text()\r\n\r\n        if (responseText) {\r\n            const encodedSimulatorMap = JSON.parse(responseText) as EncodedSimulatorMap\r\n            return decodeSimulatorMap(encodedSimulatorMap)\r\n        }\r\n    }\r\n\r\n    throw new Error(\"Invalid share\")\r\n}\r\n\r\nexport async function shareSimulatorMap(simulatorMap: SimulatorMap): Promise<string> {\r\n    const encodedSimulatorMap = encodeSimulatorMap(simulatorMap)\r\n\r\n    const response = await fetch(apiUrl, {\r\n        method: \"POST\",\r\n        mode: \"cors\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ encodedSimulatorMap: JSON.stringify(encodedSimulatorMap) })\r\n    })\r\n\r\n    if (response.ok) {\r\n        const responseObject = await response.json()\r\n        if (responseObject && responseObject.body) {\r\n            const { shareId } = JSON.parse(responseObject.body)\r\n            if (shareId) {\r\n                return shareId\r\n            }\r\n        }\r\n    }\r\n\r\n    throw new Error(\"Failed share upload\")\r\n}","import React, { ReactElement, useState, useCallback, useMemo, useRef, useEffect } from \"react\"\r\nimport { encodeMaterialMap, decodeMaterialMap, SimulatorMap, SimulationSettings, MaterialMap } from \"./serialization\"\r\nimport { FDTDSimulator, DrawShapeType } from \"./simulator\"\r\nimport { SignalSource, PointSignalSource } from \"./sources\"\r\nimport * as maps from \"./maps\"\r\nimport { QualityPreset } from \"./util\"\r\nimport { shareSimulatorMap } from \"./share\"\r\n\r\nexport type CollapsibleContainerProps = {\r\n    children: ReactElement<any> | ReactElement<any>[] | null\r\n    id?: string\r\n    className?: string\r\n    style?: React.CSSProperties\r\n    buttonStyle?: React.CSSProperties\r\n    title?: string\r\n    initiallyCollapsed?: boolean\r\n}\r\n\r\nexport function CollapsibleContainer(props: CollapsibleContainerProps) {\r\n    const [collapsed, setCollapsed] = useState(props.initiallyCollapsed !== undefined ? props.initiallyCollapsed : false)\r\n\r\n    return (\r\n        <div id={props.id} className={props.className} style={{ textAlign: \"center\", background: \"rgb(33, 33, 33)\", fontWeight: \"lighter\", color: \"white\", ...props.style }}>\r\n            <button onClick={e => setCollapsed(!collapsed)} style={{ width: \"100%\", height: \"24px\", background: \"rgb(50, 50, 50)\", border: \"0px\", color: \"white\", fontWeight: \"bold\", cursor: \"pointer\", ...props.buttonStyle }}>\r\n                {props.title ? `${props.title} ` : \"\"}[{collapsed ? \"+\" : \"-\"}]\r\n            </button>\r\n            {!collapsed && props.children}\r\n        </div>\r\n    )\r\n}\r\n\r\nexport type LabeledSliderProps = {\r\n    label: string\r\n    value: number,\r\n    setValue: (value: number) => void\r\n    min: number\r\n    max: number\r\n    step: number\r\n    allowNegative?: boolean\r\n    logarithmic?: boolean\r\n    displayDigits?: number\r\n}\r\n\r\nexport function LabeledSlider(props: LabeledSliderProps) {\r\n    const { value, setValue, allowNegative, logarithmic, displayDigits } = props\r\n    const absValue = logarithmic ? Math.log2(Math.abs(value)) : Math.abs(value)\r\n\r\n    const [negative, setNegative] = useState(value < 0)\r\n\r\n    const rangeSliderRef = useRef<HTMLInputElement>(null)\r\n\r\n    const updateValue = useCallback(() => {\r\n        if (rangeSliderRef.current) {\r\n            let newValue = parseFloat(rangeSliderRef.current.value)\r\n            if (logarithmic) {\r\n                newValue = Math.pow(2, newValue)\r\n            }\r\n\r\n            setValue((negative ? -1 : 1) * newValue)\r\n        }\r\n    }, [setValue, negative, logarithmic, rangeSliderRef])\r\n\r\n    useEffect(() => updateValue(), [negative, updateValue])\r\n\r\n    const displayValue = (displayDigits !== undefined) ? value.toFixed(displayDigits) : value\r\n\r\n    return (\r\n        <div>\r\n            <label>{props.label}</label>\r\n            {allowNegative && <>\r\n                <input style={{ marginLeft: \"10px\" }} type=\"checkbox\" checked={negative} onChange={e => setNegative(e.target.checked)} /><label>Negative</label>\r\n            </>}\r\n            <div>\r\n                <input type=\"range\" ref={rangeSliderRef} min={props.min} max={props.max} value={absValue} step={props.step}\r\n                    onChange={updateValue} style={{ height: 10, width: \"100%\" }} />\r\n                <div style={{ textAlign: \"center\", lineHeight: 0.2, marginBottom: \"7px\" }}>\r\n                    {displayValue}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n\r\nexport type OptionSelectorProps = {\r\n    options: string[]\r\n    selectedOption: number\r\n    setSelectedOption: (selectedOption: number) => void\r\n    style?: React.CSSProperties\r\n    buttonStyle?: React.CSSProperties\r\n}\r\n\r\nexport function OptionSelector(props: OptionSelectorProps) {\r\n    return (\r\n        <div style={props.style}>\r\n            {props.options.map((option, optionIndex) =>\r\n                <button key={option} style={{\r\n                    backgroundColor: \"rgb(50, 50, 50)\",\r\n                    color: \"white\",\r\n                    border: optionIndex === props.selectedOption ? \"3px solid rgb(0, 150, 255)\" : \"0\",\r\n                    height: \"30px\",\r\n                    width: \"70px\",\r\n                    overflow: \"hidden\",\r\n                    textOverflow: \"hidden\",\r\n                    ...props.buttonStyle\r\n                }}\r\n                    onClick={e => props.setSelectedOption(optionIndex)}>\r\n                    {option}\r\n                </button>\r\n            )}\r\n        </div>\r\n    )\r\n}\r\n\r\nexport type SaveLoadComponentProps = {\r\n    simulator: FDTDSimulator | null\r\n    gridSize: [number, number]\r\n\r\n    shareId: string | null\r\n    setShareId: (shareId: string | null) => void\r\n\r\n    dt: number\r\n    cellSize: number\r\n}\r\n\r\nexport function SaveLoadComponent(props: SaveLoadComponentProps) {\r\n    const { shareId, setShareId, simulator, dt, cellSize, gridSize } = props\r\n\r\n    const [materialMapUrl, setMaterialMapUrl] = useState(\"\")\r\n\r\n    const getMaterialMap = useMemo<() => (MaterialMap | null)>(() => {\r\n        return () => {\r\n            if (simulator) {\r\n                const simData = simulator.getData()\r\n                return {\r\n                    permittivity: simData.permittivity.values.toArray() as number[][],\r\n                    permeability: simData.permeability.values.toArray() as number[][],\r\n                    shape: [simData.permeability.shape[0], simData.permeability.shape[1]]\r\n                }\r\n            }\r\n\r\n            return null\r\n        }\r\n    }, [simulator])\r\n\r\n    const onSaveClicked = useCallback(() => {\r\n        const materialMap = getMaterialMap()\r\n        if (materialMap) {\r\n            window.open(encodeMaterialMap(materialMap))\r\n        }\r\n    }, [getMaterialMap])\r\n\r\n    const onLoadClicked = useCallback(() => {\r\n        if (simulator) {\r\n            const materialMap = decodeMaterialMap(materialMapUrl)\r\n            if (simulator) {\r\n                simulator.loadPermeability(materialMap.permeability)\r\n                simulator.loadPermittivity(materialMap.permittivity)\r\n            }\r\n        }\r\n    }, [simulator, materialMapUrl])\r\n\r\n    const onGenerateShareUrlClicked = useCallback(() => {\r\n        const materialMap = getMaterialMap()\r\n        if (materialMap) {\r\n            shareSimulatorMap({\r\n                materialMap: materialMap,\r\n                simulationSettings: {\r\n                    cellSize: cellSize,\r\n                    dt: dt,\r\n                    gridSize: gridSize,\r\n                    simulationSpeed: 1\r\n                },\r\n                sourceDescriptors: []\r\n            }).then(shareId => setShareId(shareId)).catch(err => console.log(\"Error uploading share: \" + JSON.stringify(err)))\r\n        }\r\n    }, [getMaterialMap, setShareId, dt, cellSize, gridSize])\r\n\r\n    const shareUrl = useMemo(() => {\r\n        return shareId ? `${window.location.origin}${window.location.pathname}#${shareId}` : null\r\n    }, [shareId])\r\n    const shareUrlTextRef = useRef<HTMLInputElement>(null)\r\n\r\n    const onCopyClicked = useCallback(() => {\r\n        if (shareUrlTextRef.current) {\r\n            shareUrlTextRef.current.select()\r\n            document.execCommand(\"copy\")\r\n        }\r\n    }, [shareUrlTextRef])\r\n\r\n    const share = useMemo(() => {\r\n        const nav = window.navigator as any\r\n        if (nav && nav.share) {\r\n            return nav.share\r\n        }\r\n        return null\r\n    }, [])\r\n\r\n    const onShareClicked = useCallback(() => {\r\n        if (share) {\r\n            share({\r\n                title: \"Interactive electromagnetic wave simulator\",\r\n                url: shareUrl\r\n            }).then(() => console.log(\"Shared\")).catch((err: any) => console.error(`Share failed: ${JSON.stringify(err)}`))\r\n        }\r\n    }, [shareUrl, share])\r\n\r\n    return (\r\n        <div style={{ padding: \"10px\", paddingTop: \"0px\" }}>\r\n            <div>\r\n                <div style={{ fontSize: \"20px\" }}>Share</div>\r\n                <div>\r\n                    <button onClick={onGenerateShareUrlClicked} style={{ background: \"rgba(50, 50, 50, 100)\", border: \"0px\", color: \"white\", margin: \"2px\" }}>Generate share url</button>\r\n                </div>\r\n                <div>\r\n                    {shareUrl &&\r\n                        <div>\r\n                            <input ref={shareUrlTextRef} readOnly type=\"text\" value={shareUrl} style={{ background: \"rgba(50, 50, 50, 100)\", border: \"0px\", color: \"white\", margin: \"2px\", width: \"70%\" }} />\r\n                            <button onClick={onCopyClicked} style={{ background: \"rgba(50, 50, 50, 100)\", border: \"0px\", color: \"white\", margin: \"2px\" }}>Copy</button>\r\n                            {share && <button onClick={onShareClicked} style={{ background: \"rgba(50, 50, 50, 100)\", border: \"0px\", color: \"white\", margin: \"2px\" }}>Share</button>}\r\n                        </div>\r\n                    }\r\n                </div>\r\n            </div>\r\n\r\n            <div style={{ marginTop: \"5px\" }}>\r\n                <div style={{ fontSize: \"20px\" }}>Material image</div>\r\n                <div>\r\n                    <button onClick={onSaveClicked} style={{ background: \"rgba(50, 50, 50, 100)\", border: \"0px\", color: \"white\", margin: \"2px\" }}>Save</button>\r\n                </div>\r\n                <div>\r\n                    <input type=\"text\" onChange={e => setMaterialMapUrl(e.target.value)} style={{ background: \"rgba(50, 50, 50, 100)\", border: \"0px\", color: \"white\", margin: \"2px\" }} />\r\n                    <button onClick={onLoadClicked} style={{ background: \"rgba(50, 50, 50, 100)\", border: \"0px\", color: \"white\", margin: \"2px\" }}>Load</button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n\r\nexport type ExamplesComponentProps = {\r\n    simulator: FDTDSimulator | null\r\n\r\n    dt: number\r\n    simulationSpeed: number\r\n    cellSize: number\r\n    gridSize: [number, number]\r\n\r\n    setGridSizeLongest: (gridSizeLongest: number) => void\r\n    setDt: (dt: number) => void\r\n    setCellSize: (cellSize: number) => void\r\n    setSimulationSpeed: (simulationSpeed: number) => void\r\n    setSources: (sources: SignalSource[]) => void\r\n}\r\n\r\nexport function ExamplesComponent(props: ExamplesComponentProps) {\r\n    const { simulator, setGridSizeLongest, setDt, setCellSize, setSimulationSpeed, setSources } = props\r\n\r\n    const loadMap = useCallback((simulatorMap: SimulatorMap) => {\r\n        if (simulator) {\r\n            simulator.resetFields()\r\n            simulator.loadPermeability(simulatorMap.materialMap.permeability)\r\n            simulator.loadPermittivity(simulatorMap.materialMap.permittivity)\r\n        }\r\n\r\n        const loadedSources = simulatorMap.sourceDescriptors.map(desc => {\r\n            if (desc.type === \"point\") {\r\n                return new PointSignalSource(desc.amplitude, desc.frequency, desc.position, desc.turnOffTime)\r\n            }\r\n\r\n            throw new Error(`Unsupported source type: ${desc.type}`)\r\n        })\r\n\r\n        setCellSize(simulatorMap.simulationSettings.cellSize)\r\n        setDt(simulatorMap.simulationSettings.dt)\r\n        setSimulationSpeed(simulatorMap.simulationSettings.simulationSpeed)\r\n        setGridSizeLongest(Math.max(simulatorMap.simulationSettings.gridSize[0], simulatorMap.simulationSettings.gridSize[1]))\r\n        setSources(loadedSources)\r\n    }, [simulator, setCellSize, setDt, setSimulationSpeed, setGridSizeLongest, setSources])\r\n\r\n    const simulationSettings = useMemo<SimulationSettings>(() => {\r\n        return {\r\n            dt: props.dt,\r\n            cellSize: props.cellSize,\r\n            gridSize: props.gridSize,\r\n            simulationSpeed: props.simulationSpeed\r\n        }\r\n    }, [props.dt, props.cellSize, props.gridSize, props.simulationSpeed])\r\n\r\n    return (\r\n        <div style={{ padding: \"10px\" }}>\r\n            <button onClick={_ => loadMap(maps.empty(simulationSettings))} style={{ backgroundColor: \"rgb(50, 50, 50)\", border: \"0px\", color: \"white\", margin: \"2px\" }}>Empty</button>\r\n            <button onClick={_ => loadMap(maps.doubleSlit(simulationSettings))} style={{ backgroundColor: \"rgb(50, 50, 50)\", border: \"0px\", color: \"white\", margin: \"2px\" }}>Double slit</button>\r\n            <button onClick={_ => loadMap(maps.fiberOptics(simulationSettings))} style={{ backgroundColor: \"rgb(50, 50, 50)\", border: \"0px\", color: \"white\", margin: \"2px\" }}>Fiber optics</button>\r\n            <button onClick={_ => loadMap(maps.lens(simulationSettings))} style={{ backgroundColor: \"rgb(50, 50, 50)\", border: \"0px\", color: \"white\", margin: \"2px\" }}>Lens</button>\r\n        </div>\r\n    )\r\n}\r\n\r\nexport type SettingsComponentProps = {\r\n    gridSizeLongest: number\r\n    setGridSizeLongest: (gridSizeLongest: number) => void\r\n\r\n    dt: number\r\n    setDt: (dt: number) => void\r\n\r\n    cellSize: number\r\n    setCellSize: (cellSize: number) => void\r\n\r\n    resolutionScale: number\r\n    setResolutionScale: (resolutionScale: number) => void\r\n\r\n    simulationSpeed: number\r\n    setSimulationSpeed: (simulationSpeed: number) => void\r\n\r\n    reflectiveBoundary: boolean\r\n    setReflectiveBoundary: (reflectiveBoundary: boolean) => void\r\n\r\n    qualityPresets: { [presetName: string]: QualityPreset }\r\n}\r\n\r\nexport function SettingsComponent(props: SettingsComponentProps) {\r\n    const { qualityPresets, setCellSize, setGridSizeLongest, setResolutionScale, setDt } = props\r\n\r\n    const onPresetClicked = useCallback((preset: QualityPreset) => {\r\n        setCellSize(preset.cellSize)\r\n        setGridSizeLongest(preset.gridSizeLongest)\r\n        setResolutionScale(preset.resolutionScale)\r\n        setDt(preset.dt)\r\n    }, [setCellSize, setGridSizeLongest, setResolutionScale, setDt])\r\n\r\n    return (\r\n        <div style={{ padding: \"10px\" }}>\r\n            <div>Quality presets</div>\r\n            <div>\r\n                {Object.keys(qualityPresets).map(presetName =>\r\n                    <button key={presetName} onClick={_ => onPresetClicked(qualityPresets[presetName])}\r\n                        style={{ backgroundColor: \"rgb(50, 50, 50)\", border: \"0px\", color: \"white\", margin: \"2px\" }}>\r\n                        {presetName}\r\n                    </button>\r\n                )}\r\n            </div>\r\n            <LabeledSlider label=\"Grid length\" value={props.gridSizeLongest} setValue={props.setGridSizeLongest} min={100} max={2000} step={100} />\r\n            <LabeledSlider label=\"Time step size\" value={props.dt} setValue={props.setDt} min={0.001} max={0.1} step={0.001} allowNegative={true} />\r\n            <LabeledSlider label=\"Cell size\" value={props.cellSize} setValue={props.setCellSize} min={0.002} max={0.2} step={0.001} />\r\n            <LabeledSlider label=\"Resolution scale\" value={props.resolutionScale} setValue={props.setResolutionScale} min={0.1} max={2} step={0.1} />\r\n            <LabeledSlider label=\"Simulation speed\" value={props.simulationSpeed} setValue={props.setSimulationSpeed} min={0} max={10} step={0.1} />\r\n            <input type=\"checkbox\" checked={props.reflectiveBoundary} onChange={e => props.setReflectiveBoundary(e.target.checked)} />Reflective boundary\r\n        </div>\r\n    )\r\n}\r\n\r\nexport type ControlComponentProps = {\r\n    signalBrushSize: number\r\n    setSignalBrushSize: (brushSize: number) => void\r\n\r\n    signalBrushValue: number\r\n    setSignalBrushValue: (brushValue: number) => void\r\n\r\n    materialBrushSize: number\r\n    setMaterialBrushSize: (brushSize: number) => void\r\n\r\n    permeabilityBrushValue: number\r\n    setPermeabilityBrushValue: (brushValue: number) => void\r\n\r\n    permittivityBrushValue: number\r\n    setPermittivityBrushValue: (brushValue: number) => void\r\n\r\n    signalFrequency: number\r\n    setSignalFrequency: (signalFrequency: number) => void\r\n\r\n    clickOption: number\r\n    setClickOption: (clickOption: number) => void\r\n\r\n    resetFields: () => void\r\n    resetMaterials: () => void\r\n\r\n    drawShapeType: DrawShapeType\r\n    setDrawShapeType: (drawShapeType: DrawShapeType) => void\r\n\r\n    snapInput: boolean\r\n    setSnapInput: (snapInput: boolean) => void\r\n}\r\n\r\nexport function ControlComponent(props: ControlComponentProps) {\r\n    const showSignal = props.clickOption === 1\r\n\r\n    const { drawShapeType, setDrawShapeType } = props\r\n\r\n    const drawShapeTypeIndex = useMemo(() => drawShapeType === \"square\" ? 0 : 1, [drawShapeType])\r\n    const setDrawShapeTypeIndex = useCallback((index: number) => setDrawShapeType(index === 0 ? \"square\" : \"circle\"), [setDrawShapeType])\r\n\r\n    const brushSizeLabel = useMemo(() => drawShapeType === \"square\" ? \"Brush size\" : \"Brush radius\", [drawShapeType])\r\n\r\n    return (\r\n        <div style={{ padding: \"10px\" }}>\r\n            <input type=\"checkbox\" checked={props.snapInput} onChange={e => props.setSnapInput(e.target.checked)} /><label>Snap to 45 line</label>\r\n            <OptionSelector buttonStyle={{ height: \"24px\" }} options={[\"Square\", \"Circle\"]} selectedOption={drawShapeTypeIndex} setSelectedOption={setDrawShapeTypeIndex} />\r\n            <div style={{ display: showSignal ? undefined : \"none\" }}>\r\n                <LabeledSlider label={brushSizeLabel} value={props.signalBrushSize} setValue={props.setSignalBrushSize} min={1} max={100} step={1} />\r\n                <LabeledSlider label=\"Signal amplitude\" value={props.signalBrushValue} setValue={props.setSignalBrushValue} min={1} max={100} step={1} />\r\n                <LabeledSlider label=\"Signal frequency\" value={props.signalFrequency} setValue={props.setSignalFrequency} min={0} max={25} step={0.25} />\r\n            </div>\r\n            <div style={{ display: !showSignal ? undefined : \"none\" }}>\r\n                <LabeledSlider label={brushSizeLabel} value={props.materialBrushSize} setValue={props.setMaterialBrushSize} min={1} max={100} step={1} />\r\n                <LabeledSlider label=\" value\" value={props.permittivityBrushValue} setValue={props.setPermittivityBrushValue} min={-1} max={10} step={0.1} allowNegative={true} logarithmic={true} displayDigits={1} />\r\n                <LabeledSlider label=\" value\" value={props.permeabilityBrushValue} setValue={props.setPermeabilityBrushValue} min={-1} max={10} step={0.1} allowNegative={true} logarithmic={true} displayDigits={1} />\r\n            </div>\r\n            <OptionSelector style={{ margin: \"10px\" }} options={[\"Material\", \"Signal\"]} selectedOption={props.clickOption} setSelectedOption={props.setClickOption} />\r\n            <div>\r\n                <button onClick={props.resetFields} style={{ backgroundColor: \"rgb(50, 50, 50)\", border: \"0px\", color: \"white\", margin: \"2px\", width: \"130px\" }}>Reset fields</button>\r\n                <button onClick={props.resetMaterials} style={{ backgroundColor: \"rgb(50, 50, 50)\", border: \"0px\", color: \"white\", margin: \"2px\", width: \"130px\" }}>Reset materials</button>\r\n            </div>\r\n        </div>\r\n    )\r\n}","import { SimulatorMap, MaterialMap, SourceDescriptor, SimulationSettings } from \"./serialization\"\r\n\r\nexport function empty(simulationSettings: SimulationSettings): SimulatorMap {\r\n    const materialMap: MaterialMap = {\r\n        permittivity: [],\r\n        permeability: [],\r\n        shape: simulationSettings.gridSize\r\n    }\r\n\r\n    for (let y = 0; y < simulationSettings.gridSize[1]; y++) {\r\n        materialMap.permittivity.push(new Array(simulationSettings.gridSize[0]).fill(1))\r\n        materialMap.permeability.push(new Array(simulationSettings.gridSize[0]).fill(1))\r\n    }\r\n\r\n    const sourceDescriptors: SourceDescriptor[] = []\r\n\r\n    return {\r\n        sourceDescriptors: sourceDescriptors,\r\n        simulationSettings: simulationSettings,\r\n        materialMap: materialMap\r\n    }\r\n}\r\n\r\nexport function doubleSlit(simulationSettings: SimulationSettings): SimulatorMap {\r\n    const materialMap: MaterialMap = {\r\n        permittivity: [],\r\n        permeability: [],\r\n        shape: simulationSettings.gridSize\r\n    }\r\n\r\n    const slitCenterX = Math.round(0.75 * simulationSettings.gridSize[0])\r\n\r\n    const slitSize = 0.2 / simulationSettings.cellSize\r\n\r\n    for (let y = 0; y < simulationSettings.gridSize[1]; y++) {\r\n        const isWallRow = Math.abs(y - simulationSettings.gridSize[1] / 5) < 2\r\n        const permittivityRow = new Array(simulationSettings.gridSize[0]).fill(isWallRow ? 100 : 1)\r\n\r\n        if (isWallRow) {\r\n            for (let x = slitCenterX - slitSize * 2; x < slitCenterX - slitSize; x++) {\r\n                permittivityRow[x] = 1\r\n            }\r\n\r\n            for (let x = slitCenterX + slitSize * 2; x > slitCenterX + slitSize; x--) {\r\n                permittivityRow[x] = 1\r\n            }\r\n        }\r\n\r\n        materialMap.permittivity.push(permittivityRow)\r\n        materialMap.permeability.push(new Array(simulationSettings.gridSize[0]).fill(1))\r\n    }\r\n\r\n    const sourceDescriptors: SourceDescriptor[] = [{\r\n        type: \"point\",\r\n        amplitude: 30000,\r\n        frequency: 3,\r\n        position: [Math.round(slitCenterX), Math.round(simulationSettings.gridSize[1] / 15)]\r\n    }]\r\n\r\n    return {\r\n        sourceDescriptors: sourceDescriptors,\r\n        simulationSettings: simulationSettings,\r\n        materialMap: materialMap\r\n    }\r\n}\r\n\r\nexport function fiberOptics(simulationSettings: SimulationSettings): SimulatorMap {\r\n    const materialMap: MaterialMap = {\r\n        permittivity: [],\r\n        permeability: [],\r\n        shape: simulationSettings.gridSize\r\n    }\r\n\r\n    for (let y = 0; y < simulationSettings.gridSize[1]; y++) {\r\n        materialMap.permittivity.push(new Array(simulationSettings.gridSize[0]).fill(1))\r\n        materialMap.permeability.push(new Array(simulationSettings.gridSize[0]).fill(1))\r\n    }\r\n\r\n    function getCurvePoint(t: number): [number, number] {\r\n        return [\r\n            Math.round(simulationSettings.gridSize[0] * 3 / 4 + simulationSettings.gridSize[0] / 5 * 0.5 / (2 * t + 1) * -Math.sin(2 * Math.PI * t)),\r\n            Math.round(simulationSettings.gridSize[1] * (1 / 10 + t * (1 - 2 / 10)))\r\n        ]\r\n    }\r\n\r\n    const numPoints = 100\r\n    const thickness = 0.04 / simulationSettings.cellSize\r\n    for (let t = 0; t < numPoints; t++) {\r\n        const pos = getCurvePoint(t / numPoints)\r\n\r\n        for (let x = -thickness + pos[0]; x < thickness + pos[0]; x++) {\r\n            for (let y = -thickness + pos[1]; y < thickness + pos[1]; y++) {\r\n                if (x >= 0 && y >= 0 && x < simulationSettings.gridSize[0] && y < simulationSettings.gridSize[1]) {\r\n                    materialMap.permittivity[y][x] = 2\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    const endPoint = getCurvePoint(1)\r\n\r\n    const sourceDescriptors: SourceDescriptor[] = [{\r\n        type: \"point\",\r\n        amplitude: 8000,\r\n        frequency: 5,\r\n        position: [endPoint[0] - 1, endPoint[1]],\r\n        turnOffTime: 0.5\r\n    }, {\r\n        type: \"point\",\r\n        amplitude: 8000,\r\n        frequency: 5,\r\n        position: [endPoint[0] + 2, endPoint[1]],\r\n        turnOffTime: 0.5\r\n    },]\r\n\r\n    return {\r\n        sourceDescriptors: sourceDescriptors,\r\n        simulationSettings: simulationSettings,\r\n        materialMap: materialMap\r\n    }\r\n}\r\n\r\nexport function lens(simulationSettings: SimulationSettings): SimulatorMap {\r\n    const materialMap: MaterialMap = {\r\n        permittivity: [],\r\n        permeability: [],\r\n        shape: simulationSettings.gridSize\r\n    }\r\n\r\n    const center = [simulationSettings.gridSize[0] * 0.6, simulationSettings.gridSize[1] / 2]\r\n\r\n    function isLensPoint(point: [number, number]) {\r\n        const dx = point[0] - center[0]\r\n        const dy = point[1] - center[1]\r\n\r\n        return 4 * dx * dx + dy * dy < simulationSettings.gridSize[0] * simulationSettings.gridSize[0] / (10 * 10)\r\n    }\r\n\r\n    for (let y = 0; y < simulationSettings.gridSize[1]; y++) {\r\n        materialMap.permittivity.push([])\r\n        materialMap.permeability.push(new Array(simulationSettings.gridSize[0]).fill(1))\r\n        for (let x = 0; x < simulationSettings.gridSize[0]; x++) {\r\n            materialMap.permittivity[y].push(isLensPoint([x, y]) ? 3 : 1)\r\n        }\r\n    }\r\n\r\n    const sourceDescriptors: SourceDescriptor[] = [{\r\n        type: \"point\",\r\n        amplitude: 20000,\r\n        frequency: 2,\r\n        position: [Math.round(simulationSettings.gridSize[0] / 10), Math.round(simulationSettings.gridSize[1] / 2)],\r\n        turnOffTime: 0.5\r\n    }]\r\n\r\n    return {\r\n        sourceDescriptors: sourceDescriptors,\r\n        simulationSettings: simulationSettings,\r\n        materialMap: materialMap\r\n    }\r\n}","export function toggleFullScreen() {\r\n    if (!document.fullscreenElement) {\r\n        document.documentElement.requestFullscreen()\r\n    } else if (document.exitFullscreen) {\r\n        document.exitFullscreen()\r\n    }\r\n}\r\n\r\nexport function clamp(min: number, max: number, value: number) {\r\n    return Math.max(min, Math.min(max, value))\r\n}\r\n\r\nexport type QualityPreset = {\r\n    dt: number\r\n    cellSize: number\r\n    gridSizeLongest: number\r\n    resolutionScale: number\r\n}","import { IKernelFunctionThis } from \"gpu.js\"\r\n\r\nexport function getAt(field: number[][], shapeX: number, shapeY: number, x: number, y: number) {\r\n    if (x < 0 || x >= shapeX || y < 0 || y >= shapeY) {\r\n        return 0\r\n    }\r\n\r\n    return field[y][x]\r\n}\r\n\r\nexport function drawGpu(this: IKernelFunctionThis, electricFieldX: number[][], electricFieldY: number[][], electricFieldZ: number[][],\r\n    magneticFieldX: number[][], magneticFieldY: number[][], magneticFieldZ: number[][],\r\n    permittivity: number[][], permeability: number[][], gridSize: number[], cellSize: number) {\r\n    const gx = gridSize[0]\r\n    const gy = gridSize[1]\r\n\r\n    const x = gx * this.thread.x! / (this.output.x as number)\r\n    const y = gy * (1 - this.thread.y! / (this.output.y as number))\r\n\r\n    // Make brighter for finer grids. As there are more cells, the energy is spread out instead\r\n    // of concentrated in less cells so we need to make it brighter.\r\n    const fieldBrightness = (0.02 * 0.02) / (cellSize * cellSize)\r\n\r\n    const eX = getAt(electricFieldX, gx, gy, x, y)\r\n    const eY = getAt(electricFieldY, gx, gy, x, y)\r\n    const eZ = getAt(electricFieldZ, gx, gy, x, y)\r\n    const eAA = fieldBrightness * fieldBrightness * (eX * eX + eY * eY + eZ * eZ)\r\n\r\n    // Magnetic field is offset from electric field, so get value at -0.5 by interpolating 0 and 1\r\n    const mX = getAt(magneticFieldX, gx, gy, x - 0.5, y - 0.5)\r\n    const mY = getAt(magneticFieldY, gx, gy, x - 0.5, y - 0.5)\r\n    const mZ = getAt(magneticFieldZ, gx, gy, x - 0.5, y - 0.5)\r\n    const mAA = fieldBrightness * fieldBrightness * (mX * mX + mY * mY + mZ * mZ)\r\n\r\n    // Material constants are between 1 and 100, map to [0, 1] using tanh(0.5 * x)\r\n    const permittivityValue = (2 / (1 + Math.exp(-0.4 * (getAt(permittivity, gx, gy, x, y)))) - 1)\r\n    const permeabilityValue = (2 / (1 + Math.exp(-0.4 * (getAt(permeability, gx, gy, x, y)))) - 1)\r\n\r\n    const tileFactorX = Math.max(1, gridSize[0] / this.output.x)\r\n    const tileFactorY = Math.max(1, gridSize[1] / this.output.y!)\r\n\r\n    const backgroundX = (Math.abs((tileFactorX * x) % 1 - 0.5) < 0.25 ? 1 : 0) * (Math.abs((tileFactorY * y) % 1 - 0.5) < 0.25 ? 1 : 0)\r\n    const backgroundY = 1 - backgroundX\r\n\r\n    this.color(\r\n        Math.min(1, eAA + 0.8 * backgroundX * permittivityValue),\r\n        Math.min(1, eAA + mAA),\r\n        Math.min(1, mAA + 0.8 * backgroundY * permeabilityValue))\r\n}\r\n\r\n// On CPU we can't use float indices so round the coordinates\r\nexport function drawCpu(this: IKernelFunctionThis, electricFieldX: number[][], electricFieldY: number[][], electricFieldZ: number[][],\r\n    magneticFieldX: number[][], magneticFieldY: number[][], magneticFieldZ: number[][],\r\n    permittivity: number[][], permeability: number[][], gridSize: number[], cellSize: number) {\r\n    const gx = gridSize[0]\r\n    const gy = gridSize[1]\r\n\r\n    const fx = gx * this.thread.x! / (this.output.x as number)\r\n    const fy = gy * (1 - this.thread.y! / (this.output.y as number))\r\n    const x = Math.round(fx)\r\n    const y = Math.round(fy)\r\n\r\n    // Make brighter for finer grids. As there are more cells, the energy is spread out instead\r\n    // of concentrated in less cells so we need to make it brighter.\r\n    const fieldBrightness = (0.02 * 0.02) / (cellSize * cellSize)\r\n\r\n    const eX = getAt(electricFieldX, gx, gy, x, y)\r\n    const eY = getAt(electricFieldY, gx, gy, x, y)\r\n    const eZ = getAt(electricFieldZ, gx, gy, x, y)\r\n    const eAA = fieldBrightness * fieldBrightness * (eX * eX + eY * eY + eZ * eZ)\r\n\r\n    // Magnetic field is offset from electric field, so get value at -0.5 by interpolating 0 and 1\r\n    const mX = getAt(magneticFieldX, gx, gy, x, y)\r\n    const mY = getAt(magneticFieldY, gx, gy, x, y)\r\n    const mZ = getAt(magneticFieldZ, gx, gy, x, y)\r\n    const mAA = fieldBrightness * fieldBrightness * (mX * mX + mY * mY + mZ * mZ)\r\n\r\n    // Material constants are between 1 and 100, map to [0, 1] using tanh(0.5 * x)\r\n    const permittivityValue = (2 / (1 + Math.exp(-0.4 * (getAt(permittivity, gx, gy, x, y)))) - 1)\r\n    const permeabilityValue = (2 / (1 + Math.exp(-0.4 * (getAt(permeability, gx, gy, x, y)))) - 1)\r\n\r\n    const tileFactorX = Math.max(1, gridSize[0] / this.output.x)\r\n    const tileFactorY = Math.max(1, gridSize[1] / this.output.y!)\r\n\r\n    const backgroundX = (Math.abs((tileFactorX * fx) % 1 - 0.5) < 0.25 ? 1 : 0) * (Math.abs((tileFactorY * fy) % 1 - 0.5) < 0.25 ? 1 : 0)\r\n    const backgroundY = 1 - backgroundX\r\n\r\n    this.color(\r\n        Math.min(1, eAA + 0.8 * backgroundX * permittivityValue),\r\n        Math.min(1, eAA + mAA),\r\n        Math.min(1, mAA + 0.8 * backgroundY * permeabilityValue))\r\n}","import React, { useRef, useCallback, useEffect, useState, useMemo } from 'react'\nimport { GPU, GPUMode, GPUInternalMode } from \"gpu.js\"\nimport { FDTDSimulator, makeDrawSquareInfo, makeDrawCircleInfo, DrawShapeType } from \"./simulator\"\nimport { CollapsibleContainer, ControlComponent, SaveLoadComponent, SettingsComponent, ExamplesComponent } from './components'\nimport { toggleFullScreen, clamp, QualityPreset } from './util'\nimport Fullscreen from \"./icons/fullscreen.png\"\nimport \"./App.css\"\nimport { SignalSource } from './sources'\nimport * as k from './kernels/rendering'\nimport { getSharedSimulatorMap } from './share'\n\nfunction getGpuMode(): GPUMode | GPUInternalMode {\n    if (GPU.isSinglePrecisionSupported) {\n        if (GPU.isWebGL2Supported) {\n            return \"webgl2\"\n        } else if (GPU.isWebGLSupported) {\n            return \"webgl\"\n        }\n    }\n\n    return \"cpu\"\n}\n\nconst qualityPresets: { [presetName: string]: QualityPreset } = {\n    \"Low\": {\n        dt: 0.013 * 2,\n        cellSize: 0.02 * 2,\n        resolutionScale: 0.3,\n        gridSizeLongest: 400 / 2\n    },\n    \"Medium\": {\n        dt: 0.013,\n        cellSize: 0.02,\n        resolutionScale: 1,\n        gridSizeLongest: 400\n    },\n    \"High\": {\n        dt: 0.013 / 2,\n        cellSize: 0.02 / 2,\n        resolutionScale: 1,\n        gridSizeLongest: 400 * 2\n    },\n    \"Ultra\": {\n        dt: 0.013 / 4,\n        cellSize: 0.02 / 4,\n        resolutionScale: 1,\n        gridSizeLongest: 400 * 4\n    }\n}\n\nconst gpuMode = getGpuMode()\nconsole.log(`Using GPU mode ${gpuMode}`)\n\nconst defaultPreset = gpuMode === \"cpu\" ? qualityPresets[\"Low\"] : qualityPresets[\"Medium\"]\n\nconst defaultSignalBrushValue = 10\nconst defaultSignalBrushSize = 1\nconst defaultSignalFrequency = gpuMode === \"cpu\" ? 1 : 3\nconst defaultPermittivityBrushValue = 5\nconst defaultPermeabilityBrushValue = 1\nconst defaultMaterialBrushSize = 5\nconst defaultDrawShapeType = \"square\"\n\nconst initialDt = defaultPreset.dt\nconst initialCellSize = defaultPreset.cellSize\nconst initialSimulationSpeed = 1\nconst initialGridSizeLongest = defaultPreset.gridSizeLongest\nconst initialResolutionScale = defaultPreset.resolutionScale\nconst initialWindowSize: [number, number] = [window.innerWidth, window.innerHeight]\nconst initialCanvasSize: [number, number] = calculateCanvasSize(initialWindowSize, initialResolutionScale)\nconst initialGridSize: [number, number] = calculateGridSize(initialGridSizeLongest, initialCanvasSize)\nconst initialReflectiveBoundary = false\n\nfunction calculateCanvasSize(windowSize: [number, number], resolutionScale: number): [number, number] {\n    return [Math.round(windowSize[0] * resolutionScale), Math.round(windowSize[1] * resolutionScale)]\n}\n\nfunction calculateGridSize(gridSizeLongest: number, canvasSize: [number, number]): [number, number] {\n    const canvasAspect = canvasSize[0] / canvasSize[1]\n\n    return canvasSize[0] >= canvasSize[1] ?\n        [gridSizeLongest, Math.ceil(gridSizeLongest / canvasAspect)] :\n        [Math.ceil(gridSizeLongest * canvasAspect), gridSizeLongest]\n}\n\nconst makeRenderSimulatorCanvas = (gpu: GPU, canvasSize: [number, number]) => {\n    const kernel = gpuMode !== \"cpu\" ? gpu.createKernel(k.drawGpu) : gpu.createKernel(k.drawCpu)\n    return kernel.setOutput(canvasSize).setGraphical(true).setFunctions([k.getAt]).setWarnVarUsage(false).setTactic(\"performance\").setPrecision(\"unsigned\").setDynamicOutput(true).setDynamicArguments(true)\n}\n\nexport default function () {\n    const urlShareId = window.location.hash ? window.location.hash.substr(1) : null\n    const [shareId, setShareId] = useState<string | null>(urlShareId)\n\n    const drawCanvasRef = useRef<HTMLCanvasElement>(null)\n\n    const [canvasSize, setCanvasSize] = useState<[number, number]>(initialCanvasSize)\n    const [windowSize, setWindowSize] = useState<[number, number]>(initialWindowSize)\n    const [gridSizeLongest, setGridSizeLongest] = useState(initialGridSizeLongest)\n    const [dt, setDt] = useState(initialDt)\n    const [cellSize, setCellSize] = useState(initialCellSize)\n    const [resolutionScale, setResolutionScale] = useState(initialResolutionScale)\n    const [simulationSpeed, setSimulationSpeed] = useState(initialSimulationSpeed)\n    const [reflectiveBoundary, setReflectiveBoundary] = useState(initialReflectiveBoundary)\n\n    const [sources, setSources] = useState<SignalSource[]>([])\n\n    useEffect(() => {\n        const adjustCanvasSize = () => {\n            const wndSize: [number, number] = [window.innerWidth, window.innerHeight]\n            setCanvasSize(calculateCanvasSize(wndSize, resolutionScale))\n            setWindowSize(wndSize)\n        }\n\n        adjustCanvasSize()\n\n        window.addEventListener(\"resize\", adjustCanvasSize)\n        return () => window.removeEventListener(\"resize\", adjustCanvasSize)\n    }, [resolutionScale])\n\n    const gridSize = useMemo<[number, number]>(() => calculateGridSize(gridSizeLongest, canvasSize), [canvasSize, gridSizeLongest])\n\n    // Would use useMemo for gpu here, but useMemo does not seem to work with ref dependencies.\n    const [gpu, setGpu] = useState<GPU | null>(null)\n    useEffect(() => {\n        if (drawCanvasRef.current) {\n            setGpu(new GPU({ mode: gpuMode, canvas: drawCanvasRef.current }))\n        }\n    }, [drawCanvasRef])\n\n    const simulator = useMemo(() => gpu ? new FDTDSimulator(gpu, initialGridSize, initialCellSize, initialReflectiveBoundary) : null, [gpu])\n    const renderSim = useMemo(() => gpu ? makeRenderSimulatorCanvas(gpu, initialGridSize) : null, [gpu])\n\n    // Load share id\n    useEffect(() => {\n        if (simulator && urlShareId) {\n            console.log(`Loading ${urlShareId}`)\n            getSharedSimulatorMap(urlShareId).then(simulatorMap => {\n                simulator.loadPermittivity(simulatorMap.materialMap.permittivity)\n                simulator.loadPermeability(simulatorMap.materialMap.permeability)\n                setDt(simulatorMap.simulationSettings.dt)\n                setGridSizeLongest(Math.max(simulatorMap.simulationSettings.gridSize[0], simulatorMap.simulationSettings.gridSize[1]))\n                setCellSize(simulatorMap.simulationSettings.cellSize)\n                console.log(`Loaded ${urlShareId}`)\n            }).catch(err => console.error(`Error getting share ${urlShareId}: ${JSON.stringify(err)}`))\n        }\n    }, [simulator, urlShareId])\n\n    // Update render sim output size\n    useEffect(() => {\n        if (renderSim) {\n            renderSim.setOutput(canvasSize)\n        }\n    }, [renderSim, canvasSize])\n\n    // Update simulator grid size\n    useEffect(() => {\n        if (simulator) {\n            simulator.setGridSize(gridSize)\n        }\n    }, [simulator, gridSize])\n\n    // Update simulator cell size\n    useEffect(() => {\n        if (simulator) {\n            simulator.setCellSize(cellSize)\n        }\n    }, [simulator, cellSize])\n\n    // Update reflective boundary\n    useEffect(() => {\n        if (simulator) {\n            simulator.reflectiveBoundary = reflectiveBoundary\n        }\n    }, [simulator, reflectiveBoundary])\n\n    const [signalBrushSize, setSignalBrushSize] = useState(defaultSignalBrushSize)\n    const [signalBrushValue, setSignalBrushValue] = useState(defaultSignalBrushValue)\n    const [drawShapeType, setDrawShapeType] = useState<DrawShapeType>(defaultDrawShapeType)\n\n    const [materialBrushSize, setMaterialBrushSize] = useState(defaultMaterialBrushSize)\n    const [permittivityBrushValue, setPermittivityBrushValue] = useState(defaultPermittivityBrushValue)\n    const [permeabilityBrushValue, setPermeabilityBrushValue] = useState(defaultPermeabilityBrushValue)\n    const [signalFrequency, setSignalFrequency] = useState(defaultSignalFrequency)\n    const [drawingMaterial, setDrawingMaterial] = useState(false)\n    const optionMaterialBrush = 0\n    const optionSignal = 1\n    const [clickOption, setClickOption] = useState(optionSignal) // material, signal\n\n    const [mousePosition, setMousePosition] = useState<[number, number] | null>(null)\n\n    const signalStrength = useRef(0)\n    const mouseDownPos = useRef<[number, number] | null>(null)\n\n    // Snap input across a line\n    const [snapInput, setSnapInput] = useState(false)\n    const [inputStartPos, setInputStartPos] = useState<[number, number] | null>(null)\n    const [inputDir, setInputDir] = useState<[number, number] | null>(null)\n\n    const windowToSimulationPoint = useMemo(() => {\n        return (windowPoint: [number, number]) => {\n            const simulationPoint: [number, number] = [\n                clamp(0, gridSize[0] - 1, Math.floor(gridSize[0] * windowPoint[0] / windowSize[0])),\n                clamp(0, gridSize[1] - 1, Math.floor(gridSize[1] * windowPoint[1] / windowSize[1]))\n            ]\n            return simulationPoint\n        }\n    }, [windowSize, gridSize])\n\n    const simStep = useCallback(() => {\n        if (simulator) {\n            const simData = simulator.getData()\n\n            if (mouseDownPos.current !== null) {\n                const center = windowToSimulationPoint(mouseDownPos.current)\n                const brushHalfSize = Math.round(signalBrushSize / 2)\n                const value = -signalBrushValue * 2000 * Math.cos(2 * Math.PI * signalFrequency * simData.time)\n\n                const drawInfo = drawShapeType === \"square\" ?\n                    makeDrawSquareInfo(center, brushHalfSize, value) :\n                    makeDrawCircleInfo(center, brushHalfSize, value)\n\n                simulator.injectSignal(drawInfo, dt)\n            }\n\n            for (const source of sources) {\n                source.inject(simulator, dt)\n            }\n\n            simulator.stepMagnetic(dt)\n            simulator.stepElectric(dt)\n        }\n    }, [simulator, dt, signalFrequency, signalBrushValue, signalBrushSize, sources, windowToSimulationPoint, drawShapeType])\n\n    useEffect(() => {\n        if (simulationSpeed > 0) {\n            const timer = setInterval(simStep, 1000 / simulationSpeed * dt)\n            return () => clearInterval(timer)\n        }\n\n        return undefined\n    }, [simStep, dt, simulationSpeed])\n\n    const drawStep = useCallback(() => {\n        if (simulator && renderSim) {\n            if (drawCanvasRef.current) {\n                const cnvSize = calculateCanvasSize([window.innerWidth, window.innerHeight], resolutionScale)\n                drawCanvasRef.current.width = cnvSize[0]\n                drawCanvasRef.current.height = cnvSize[1]\n            }\n\n            const simData = simulator.getData()\n\n            renderSim(simData.electricField[0].values, simData.electricField[1].values, simData.electricField[2].values,\n                simData.magneticField[0].values, simData.magneticField[1].values, simData.magneticField[2].values,\n                simData.permittivity.values, simData.permeability.values, gridSize, cellSize)\n        }\n    }, [simulator, renderSim, gridSize, cellSize, resolutionScale, drawCanvasRef])\n\n    useEffect(() => {\n        let stop = false\n        const drawIfNotStopped = () => {\n            if (!stop) {\n                drawStep()\n                requestAnimationFrame(drawIfNotStopped)\n            }\n        }\n\n        requestAnimationFrame(drawIfNotStopped)\n\n        return () => { stop = true }\n    }, [drawStep])\n\n    const changeMaterial = useCallback((canvasPos: [number, number]) => {\n        if (simulator) {\n            const center: [number, number] = [\n                Math.round(gridSize[0] * (canvasPos[0] / windowSize[0])),\n                Math.round(gridSize[1] * (canvasPos[1] / windowSize[1]))\n            ]\n            const brushHalfSize = Math.round(materialBrushSize / 2)\n\n            simulator.drawMaterial(\"permittivity\", drawShapeType === \"square\" ?\n                makeDrawSquareInfo(center, brushHalfSize, permittivityBrushValue) :\n                makeDrawCircleInfo(center, brushHalfSize, permittivityBrushValue))\n\n            simulator.drawMaterial(\"permeability\", drawShapeType === \"square\" ?\n                makeDrawSquareInfo(center, brushHalfSize, permeabilityBrushValue) :\n                makeDrawCircleInfo(center, brushHalfSize, permeabilityBrushValue))\n        }\n    }, [simulator, gridSize, windowSize, materialBrushSize, permittivityBrushValue, permeabilityBrushValue, drawShapeType])\n\n    const resetMaterials = useCallback(() => {\n        if (simulator) {\n            simulator.resetMaterials()\n        }\n    }, [simulator])\n\n    const resetFields = useCallback(() => {\n        if (simulator) {\n            simulator.resetFields()\n            signalStrength.current = 0\n        }\n    }, [simulator])\n\n    const onInputDown = useCallback((clientPos: [number, number]) => {\n        if (simulator) {\n            setInputStartPos(clientPos)\n\n            if (clickOption === optionSignal) {\n                mouseDownPos.current = clientPos\n            } else if (clickOption === optionMaterialBrush) {\n                changeMaterial(clientPos)\n                setDrawingMaterial(true)\n            }\n        }\n    }, [simulator, changeMaterial, clickOption])\n\n    const onInputMove = useCallback((clientPos: [number, number], shiftDown?: boolean) => {\n        if (simulator) {\n            let pos: [number, number] = clientPos\n\n            // If snapping, change the position to lie along the draw line\n            if ((snapInput || shiftDown) && inputStartPos) {\n                const offset = [pos[0] - inputStartPos[0], pos[1] - inputStartPos[1]]\n                if (inputDir) {\n                    const projection = offset[0] * inputDir[0] + offset[1] * inputDir[1]\n                    pos = [inputStartPos[0] + projection * inputDir[0], inputStartPos[1] + projection * inputDir[1]]\n                } else {\n                    const offsetLengthSq = offset[0] * offset[0] + offset[1] * offset[1]\n                    const minimumSnapLengthSq = 0.01 * 0.01 * (windowSize[0] * windowSize[0] + windowSize[1] * windowSize[1])\n                    if (offsetLengthSq > minimumSnapLengthSq) {\n                        // Snap to discrete angles\n                        const angleQuantum = Math.PI / 4\n                        const snappedAngle = Math.round(Math.atan2(offset[1], offset[0]) / angleQuantum) * angleQuantum\n                        const dir: [number, number] = [Math.cos(snappedAngle), Math.sin(snappedAngle)]\n                        setInputDir(dir)\n                    }\n                }\n            }\n\n            if (clickOption === optionSignal && mouseDownPos.current !== null) {\n                mouseDownPos.current = pos\n            }\n\n            if (drawingMaterial) {\n                changeMaterial(pos)\n            }\n        }\n    }, [simulator, changeMaterial, clickOption, drawingMaterial, inputDir, inputStartPos, windowSize, snapInput])\n\n    const onInputUp = useCallback(() => {\n        if (clickOption === optionSignal) {\n            mouseDownPos.current = null\n        } else if (clickOption === optionMaterialBrush) {\n            setDrawingMaterial(false)\n        }\n\n        setInputDir(null)\n        setInputStartPos(null)\n    }, [clickOption])\n\n    const activeBrushSize = useMemo(() => (clickOption === optionSignal ? signalBrushSize : materialBrushSize) * (canvasSize[0] / gridSize[0]), [clickOption, signalBrushSize, materialBrushSize, canvasSize, gridSize])\n\n    return (\n        <div style={{ touchAction: \"none\", userSelect: \"none\" }}>\n            <canvas width={canvasSize[0]} height={canvasSize[1]} ref={drawCanvasRef} style={{ position: \"absolute\", width: windowSize[0], height: windowSize[1] }}\n                onMouseDown={e => onInputDown([e.clientX, e.clientY])}\n                onMouseMove={e => { setMousePosition([e.clientX, e.clientY]); onInputMove([e.clientX, e.clientY], e.shiftKey) }}\n                onMouseUp={e => onInputUp()}\n                onMouseLeave={e => onInputUp()}\n                onTouchStart={e => { setMousePosition([e.touches[0].clientX, e.touches[0].clientY]); onInputDown([e.touches[0].clientX, e.touches[0].clientY]) }}\n                onTouchMove={e => { setMousePosition([e.touches[0].clientX, e.touches[0].clientY]); onInputMove([e.touches[0].clientX, e.touches[0].clientY]) }}\n                onTouchEnd={e => { setMousePosition(null); onInputUp() }}\n                onTouchCancel={e => { setMousePosition(null); onInputUp() }}\n                onContextMenu={e => e.preventDefault()}\n            />\n\n            <div style={{ position: \"absolute\", bottom: 10, right: 10 }}>\n                <a href=\"mailto:tora@warlock.ai?subject=EM simulation feedback\" rel=\"noopener noreferrer\" target=\"_blank\" style={{ fontWeight: \"lighter\", color: \"rgba(255, 255, 255, 100)\", textDecoration: \"none\", marginRight: \"8px\" }}>Feedback</a>\n                <a href=\"https://github.com/RobinKa/maxwell-simulation\" rel=\"noopener noreferrer\" target=\"_blank\" style={{ fontWeight: \"lighter\", color: \"rgba(255, 255, 255, 100)\", textDecoration: \"none\" }}>Source code</a>\n            </div>\n\n            {mousePosition && (drawShapeType === \"square\" ?\n                <div style={{ position: \"absolute\", pointerEvents: \"none\", left: mousePosition[0] - activeBrushSize / 2, top: mousePosition[1] - activeBrushSize / 2, width: activeBrushSize, height: activeBrushSize, border: \"2px solid yellow\" }} /> :\n                <div style={{ position: \"absolute\", pointerEvents: \"none\", left: mousePosition[0] - activeBrushSize / 2, top: mousePosition[1] - activeBrushSize / 2, width: activeBrushSize, height: activeBrushSize, border: \"2px solid yellow\", borderRadius: \"50%\" }} />)\n            }\n\n            {gpuMode === \"cpu\" &&\n                <div style={{ position: \"absolute\", pointerEvents: \"none\", left: 10, bottom: 10, color: \"red\", fontWeight: \"lighter\" }}>Using CPU (WebGL with float textures unsupported by your device)</div>\n            }\n\n            <img onClick={toggleFullScreen} src={Fullscreen} alt=\"Fullscreen\" style={{ position: \"absolute\", right: 10, top: 10, cursor: \"pointer\" }} />\n\n            <CollapsibleContainer id=\"Menu\" title=\"Menu\" buttonStyle={{ background: \"rgb(60, 60, 60)\" }}>\n                <CollapsibleContainer title=\"Examples\">\n                    <ExamplesComponent\n                        simulator={simulator} setCellSize={setCellSize} setDt={setDt}\n                        setGridSizeLongest={setGridSizeLongest} setSimulationSpeed={setSimulationSpeed}\n                        setSources={setSources} gridSize={gridSize} dt={dt}\n                        cellSize={cellSize} simulationSpeed={simulationSpeed} />\n                </CollapsibleContainer>\n                <CollapsibleContainer title=\"Controls\">\n                    <ControlComponent\n                        signalBrushSize={signalBrushSize} setSignalBrushSize={setSignalBrushSize}\n                        materialBrushSize={materialBrushSize} setMaterialBrushSize={setMaterialBrushSize}\n                        signalBrushValue={signalBrushValue} setSignalBrushValue={setSignalBrushValue}\n                        permittivityBrushValue={permittivityBrushValue} setPermittivityBrushValue={setPermittivityBrushValue}\n                        permeabilityBrushValue={permeabilityBrushValue} setPermeabilityBrushValue={setPermeabilityBrushValue}\n                        signalFrequency={signalFrequency} setSignalFrequency={setSignalFrequency}\n                        clickOption={clickOption} setClickOption={setClickOption}\n                        drawShapeType={drawShapeType} setDrawShapeType={setDrawShapeType}\n                        snapInput={snapInput} setSnapInput={setSnapInput}\n                        resetFields={resetFields} resetMaterials={resetMaterials} />\n                </CollapsibleContainer>\n                <CollapsibleContainer title=\"Share\" initiallyCollapsed={true}>\n                    <SaveLoadComponent simulator={simulator} gridSize={gridSize} shareId={shareId} setShareId={setShareId} cellSize={cellSize} dt={dt} />\n                </CollapsibleContainer>\n                <CollapsibleContainer title=\"Settings\" initiallyCollapsed={true}>\n                    <SettingsComponent\n                        gridSizeLongest={gridSizeLongest} setGridSizeLongest={setGridSizeLongest}\n                        simulationSpeed={simulationSpeed} setSimulationSpeed={setSimulationSpeed}\n                        resolutionScale={resolutionScale} setResolutionScale={setResolutionScale}\n                        cellSize={cellSize} setCellSize={setCellSize}\n                        reflectiveBoundary={reflectiveBoundary} setReflectiveBoundary={setReflectiveBoundary}\n                        dt={dt} setDt={setDt}\n                        qualityPresets={qualityPresets} />\n                </CollapsibleContainer>\n            </CollapsibleContainer>\n        </div>\n    )\n}","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === 'localhost' ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === '[::1]' ||\n    // 127.0.0.1/8 is considered localhost for IPv4.\n    window.location.hostname.match(\n      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\n    )\n);\n\ntype Config = {\n  onSuccess?: (registration: ServiceWorkerRegistration) => void;\n  onUpdate?: (registration: ServiceWorkerRegistration) => void;\n};\n\nexport function register(config?: Config) {\n  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL(\n      (process as { env: { [key: string]: string } }).env.PUBLIC_URL,\n      window.location.href\n    );\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return;\n    }\n\n    window.addEventListener('load', () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config);\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.log(\n            'This web app is being served cache-first by a service ' +\n              'worker. To learn more, visit https://bit.ly/CRA-PWA'\n          );\n        });\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config);\n      }\n    });\n  }\n}\n\nfunction registerValidSW(swUrl: string, config?: Config) {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then(registration => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing;\n        if (installingWorker == null) {\n          return;\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === 'installed') {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n              console.log(\n                'New content is available and will be used when all ' +\n                  'tabs for this page are closed. See https://bit.ly/CRA-PWA.'\n              );\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration);\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n              console.log('Content is cached for offline use.');\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration);\n              }\n            }\n          }\n        };\n      };\n    })\n    .catch(error => {\n      console.error('Error during service worker registration:', error);\n    });\n}\n\nfunction checkValidServiceWorker(swUrl: string, config?: Config) {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl)\n    .then(response => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get('content-type');\n      if (\n        response.status === 404 ||\n        (contentType != null && contentType.indexOf('javascript') === -1)\n      ) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then(registration => {\n          registration.unregister().then(() => {\n            window.location.reload();\n          });\n        });\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config);\n      }\n    })\n    .catch(() => {\n      console.log(\n        'No internet connection found. App is running in offline mode.'\n      );\n    });\n}\n\nexport function unregister() {\n  if ('serviceWorker' in navigator) {\n    navigator.serviceWorker.ready.then(registration => {\n      registration.unregister();\n    });\n  }\n}\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\nimport * as serviceWorker from './serviceWorker';\n\nReactDOM.render(<App />, document.getElementById('root'));\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\nserviceWorker.unregister();\n","module.exports = \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAABISURBVFhH7dchDgAhDETRKfe/M1TUlgyqgv8Mq+AnQMjGTjJFqs+rlzlXjWMIIKC9Be6Jd3XrsAUEAAB4jgkYD+DPiIDfA6QD/j8gGcpVf+MAAAAASUVORK5CYII=\""],"sourceRoot":""}