{"version":3,"sources":["Symplectic.ts","Context.ts","EnergyTermList.tsx","ObjectList.tsx","App.tsx","serviceWorker.ts","index.tsx"],"names":["vectorMulAddInline","a","b","f","i","length","vectorMulAdd","result","SymplecticIntegrator","constants","getEnergyGradients","iterate","state","dt","newState","cloneDeep","time","auxPosition","auxMomentum","objectId","objects","object","c","d","auxPos","auxMom","position","momentum","grads","gradMomentum","gradPosition","push","slice","appReducer","action","type","energyTerms","term","index","pop","initialPositionScale","positionScale","initialMomentumScale","momentumScale","Error","AppContext","createContext","undefined","AffectedObjectList","props","useContext","dispatch","energyTerm","map","objectIndex","isAffected","affectedObjects","key","checked","onChange","AffectedObjectPairList","otherObject","otherObjectIndex","pairIndex","toString","affectedObjectPairs","EnergyTerm","useState","formula","setFormula","parsed","setParsed","useEffect","expressionFormula","parseFormula","useCallback","energyExpression","parseExpression","expression","onFormulaChanged","e","target","value","style","border","padding","margin","width","color","onClick","EnergyTermList","expr","Constant","ObjectList","IntegratorStateCanvas","canvasRef","useRef","scale","setScale","offset","setOffset","current","canvas","ctx","getContext","fillStyle","fillRect","height","integratorState","x","y","endX","endY","strokeStyle","beginPath","moveTo","lineTo","stroke","fillText","toFixed","onWheel","console","log","Math","sign","deltaY","scrolling","setScrolling","prevMousePos","setPrevMousePos","onMouseDown","button","clientX","clientY","onMouseUp","onMouseMove","delta","ref","integratorConstants","makeSingleContext","dimensions","context","variableValues","dim","IntegratorComponent","setIntegratorState","integrator","setIntegrator","calcNextState","interval","setInterval","clearInterval","simulate","gradsPosition","gradsMomentum","termVariables","getAllVariables","energyTermGradsPosition","energyTermGradsMomentum","getDerivativeForExpression","getAllDerivatives","initialIntegratorState","forEach","random","evaluationContext","energyTermIndex","evaluate","_","pairContext","otherPosition","otherMomentum","makePairContext","parseFloat","isNaN","defaultValue","App","initialState","useReducer","useAppReducer","Provider","isLocalhost","Boolean","window","location","hostname","match","registerValidSW","swUrl","config","navigator","serviceWorker","register","then","registration","onupdatefound","installingWorker","installing","onstatechange","controller","onUpdate","onSuccess","catch","error","ReactDOM","render","document","getElementById","URL","process","href","origin","addEventListener","fetch","response","contentType","headers","get","status","indexOf","ready","unregister","reload","checkValidServiceWorker"],"mappings":"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","file":"static/js/main.a711ae47.chunk.js","sourcesContent":["import cloneDeep from \"clone-deep\"\r\n\r\n\r\nexport type ObjectState = {\r\n    position: number[]\r\n    momentum: number[]\r\n}\r\n\r\nexport type EnergyGradientFunction = (objectIndex: number, position: number[], momentum: number[], integratorState: IntegratorState) => {\r\n    gradPosition: number[],\r\n    gradMomentum: number[]\r\n}\r\n\r\nexport type IntegratorState = {\r\n    time: number\r\n    objects: ObjectState[]\r\n}\r\n\r\nexport interface Integrator {\r\n    iterate: (state: IntegratorState, dt: number) => IntegratorState\r\n}\r\n\r\nexport type SymplecticIntegratorConstants = { c: number, d: number }[]\r\n\r\nfunction vectorMulAddInline(a: number[], b: number[], f: number) {\r\n    for (let i = 0; i < a.length; i++) {\r\n        a[i] += f * b[i]\r\n    }\r\n}\r\n\r\nfunction vectorMulAdd(result: number[], a: number[], b: number[], f: number) {\r\n    for (let i = 0; i < a.length; i++) {\r\n        result[i] = a[i] + f * b[i]\r\n    }\r\n}\r\n\r\nexport class SymplecticIntegrator implements Integrator {\r\n    constructor(readonly constants: SymplecticIntegratorConstants,\r\n        readonly getEnergyGradients: EnergyGradientFunction) {\r\n    }\r\n\r\n    public iterate = (state: IntegratorState, dt: number) => {\r\n        const newState = cloneDeep(state)\r\n        newState.time += 2 * dt\r\n\r\n        const auxPosition: number[][] = []\r\n        const auxMomentum: number[][] = []\r\n\r\n        // 1. Iter\r\n\r\n        for (let objectId = 0; objectId < newState.objects.length; objectId++) {\r\n            const object = newState.objects[objectId]\r\n\r\n            const { c, d } = this.constants[0]\r\n\r\n            // Initialize aux position and momentum\r\n            const auxPos: number[] = []\r\n            const auxMom: number[] = []\r\n            auxPos.length = object.position.length\r\n            auxMom.length = object.momentum.length\r\n\r\n            // Calculate gradients at real coords\r\n            let grads = this.getEnergyGradients(objectId, object.position, object.momentum, state)\r\n            vectorMulAdd(auxPos, object.position, grads.gradMomentum, dt * d)\r\n            vectorMulAdd(auxMom, object.momentum, grads.gradPosition, dt * -d)\r\n\r\n            // Calculate gradients at aux coords\r\n            grads = this.getEnergyGradients(objectId, auxPos, auxMom, state)\r\n            vectorMulAddInline(object.position, grads.gradMomentum, dt * c)\r\n            vectorMulAddInline(object.momentum, grads.gradPosition, dt * -c)\r\n\r\n            auxPosition.push(auxPos)\r\n            auxMomentum.push(auxMom)\r\n        }\r\n\r\n        for (const { c, d } of this.constants.slice(1, this.constants.length - 1)) {\r\n            for (let objectId = 0; objectId < newState.objects.length; objectId++) {\r\n                const object = newState.objects[objectId]\r\n                const auxPos = auxPosition[objectId]\r\n                const auxMom = auxMomentum[objectId]\r\n\r\n                // Calculate gradients at real coords\r\n                let grads = this.getEnergyGradients(objectId, object.position, object.momentum, state)\r\n                vectorMulAddInline(auxPos, grads.gradMomentum, dt * d)\r\n                vectorMulAddInline(auxMom, grads.gradPosition, dt * -d)\r\n\r\n                // Calculate gradients at aux coords\r\n                grads = this.getEnergyGradients(objectId, auxPos, auxMom, state)\r\n                vectorMulAddInline(object.position, grads.gradMomentum, dt * c)\r\n                vectorMulAddInline(object.momentum, grads.gradPosition, dt * -c)\r\n            }\r\n        }\r\n\r\n        for (let objectId = 0; objectId < newState.objects.length; objectId++) {\r\n            const d = this.constants[this.constants.length - 1].d\r\n\r\n            const object = newState.objects[objectId]\r\n            const auxPos = auxPosition[objectId]\r\n\r\n            // Calculate gradients at real coords\r\n            const grads = this.getEnergyGradients(objectId, object.position, object.momentum, state)\r\n            vectorMulAdd(object.position, auxPos, grads.gradMomentum, dt * d)\r\n        }\r\n\r\n        // 2. Iter\r\n        for (let objectId = 0; objectId < newState.objects.length; objectId++) {\r\n            const object = newState.objects[objectId]\r\n\r\n            const { c, d } = this.constants[0]\r\n\r\n            // Initialize aux position and momentum\r\n            const auxPos = auxPosition[objectId]\r\n            const auxMom = auxMomentum[objectId]\r\n\r\n            // Calculate gradients at real coords\r\n            let grads = this.getEnergyGradients(objectId, object.position, object.momentum, state)\r\n            vectorMulAdd(auxPos, object.position, grads.gradMomentum, dt * d)\r\n            vectorMulAdd(auxMom, object.momentum, grads.gradPosition, dt * -d)\r\n\r\n            // Calculate gradients at aux coords\r\n            grads = this.getEnergyGradients(objectId, auxPos, auxMom, state)\r\n            vectorMulAddInline(object.position, grads.gradMomentum, dt * c)\r\n            vectorMulAddInline(object.momentum, grads.gradPosition, dt * -c)\r\n        }\r\n\r\n        for (const { c, d } of this.constants.slice(1, this.constants.length - 1)) {\r\n            for (let objectId = 0; objectId < newState.objects.length; objectId++) {\r\n                const object = newState.objects[objectId]\r\n                const auxPos = auxPosition[objectId]\r\n                const auxMom = auxMomentum[objectId]\r\n\r\n                // Calculate gradients at real coords\r\n                let grads = this.getEnergyGradients(objectId, object.position, object.momentum, state)\r\n                vectorMulAddInline(auxPos, grads.gradMomentum, dt * d)\r\n                vectorMulAddInline(auxMom, grads.gradPosition, dt * -d)\r\n\r\n                // Calculate gradients at aux coords\r\n                grads = this.getEnergyGradients(objectId, auxPos, auxMom, state)\r\n                vectorMulAddInline(object.position, grads.gradMomentum, dt * c)\r\n                vectorMulAddInline(object.momentum, grads.gradPosition, dt * -c)\r\n            }\r\n        }\r\n\r\n        for (let objectId = 0; objectId < newState.objects.length; objectId++) {\r\n            const d = this.constants[this.constants.length - 1].d\r\n\r\n            const object = newState.objects[objectId]\r\n            const auxMom = auxMomentum[objectId]\r\n\r\n            // Calculate gradients at real coords\r\n            const grads = this.getEnergyGradients(objectId, object.position, object.momentum, state)\r\n            vectorMulAdd(object.momentum, auxMom, grads.gradPosition, dt * -d)\r\n        }\r\n\r\n        return newState\r\n    }\r\n}","import { Dispatch, createContext, useReducer } from \"react\"\r\nimport { Expression, parseExpression } from \"tadiff\"\r\n\r\nexport type AppEnergyTerm = {\r\n    expression: Expression\r\n    expressionFormula: string\r\n    affectedObjects: { [objectIndex: number]: boolean }\r\n    affectedObjectPairs: { [objectIndices: string]: boolean }\r\n}\r\n\r\nexport type AppState = {\r\n    energyTerms: AppEnergyTerm[]\r\n    objects: {}[]\r\n    dimensions: number\r\n    initialPositionScale: number\r\n    initialMomentumScale: number\r\n}\r\n\r\nexport type AppActionAddEnergyTerm = {\r\n    type: \"addEnergyTerm\"\r\n    term: AppEnergyTerm\r\n}\r\n\r\nexport type AppActionUpdateEnergyTerm = {\r\n    type: \"updateEnergyTerm\"\r\n    index: number\r\n    term: AppEnergyTerm\r\n}\r\n\r\nexport type AppActionRemoveEnergyTerm = {\r\n    type: \"removeEnergyTerm\"\r\n}\r\n\r\nexport type AppActionAddObject = {\r\n    type: \"addObject\"\r\n}\r\n\r\nexport type AppActionRemoveObject = {\r\n    type: \"removeObject\"\r\n}\r\n\r\nexport type AppActionSetInitialScales = {\r\n    type: \"setInitialScales\"\r\n    positionScale: number\r\n    momentumScale: number\r\n}\r\n\r\nexport type AppAction = AppActionAddEnergyTerm | AppActionUpdateEnergyTerm |\r\n    AppActionRemoveEnergyTerm | AppActionAddObject | AppActionRemoveObject |\r\n    AppActionSetInitialScales\r\n\r\nfunction appReducer(state: AppState, action: AppAction) {\r\n    switch (action.type) {\r\n        case \"addEnergyTerm\": {\r\n            return { ...state, energyTerms: [...state.energyTerms, action.term] }\r\n        } case \"updateEnergyTerm\": {\r\n            const energyTerms = [...state.energyTerms]\r\n            energyTerms[action.index] = action.term\r\n            return { ...state, energyTerms: energyTerms }\r\n        } case \"removeEnergyTerm\": {\r\n            const energyTerms = [...state.energyTerms]\r\n            energyTerms.pop()\r\n            return { ...state, energyTerms: energyTerms }\r\n        } case \"addObject\": {\r\n            const newObject = {}\r\n            return { ...state, objects: [...state.objects, newObject] }\r\n        } case \"removeObject\": {\r\n            const objects = [...state.objects]\r\n            objects.pop()\r\n            return { ...state, objects: objects }\r\n        } case \"setInitialScales\": {\r\n            return {\r\n                ...state,\r\n                initialPositionScale: action.positionScale,\r\n                initialMomentumScale: action.momentumScale\r\n            }\r\n        }\r\n    }\r\n\r\n    throw new Error(\"Unhandled action in reducer\")\r\n}\r\n\r\nexport function useAppReducer() {\r\n    const initialState: AppState = {\r\n        energyTerms: [{\r\n            expression: parseExpression(\"0.5 * (p0 * p0 + p1 * p1)\"),\r\n            expressionFormula: \"0.5 * (p0 * p0 + p1 * p1)\",\r\n            affectedObjects: {},\r\n            affectedObjectPairs: {}\r\n        }, {\r\n            expression: parseExpression(\"-0.01 / sqrt((q0 - q0_b)^2 + (q1 - q1_b)^2)\"),\r\n            expressionFormula: \"-0.01 / sqrt((q0 - q0_b)^2 + (q1 - q1_b)^2)\",\r\n            affectedObjects: {},\r\n            affectedObjectPairs: {}\r\n        }],\r\n        objects: [],\r\n        dimensions: 2,\r\n        initialPositionScale: 5,\r\n        initialMomentumScale: 0.5\r\n    }\r\n\r\n    for (let i = 0; i < 10; i++) {\r\n        initialState.objects.push({})\r\n    }\r\n\r\n    initialState.objects.forEach((_, objectIndex) => {\r\n        initialState.energyTerms[0].affectedObjects[objectIndex] = true\r\n    })\r\n\r\n    initialState.objects.forEach((_, objectIndex) => {\r\n        initialState.objects.forEach((_, otherObjectIndex) => {\r\n            if (objectIndex !== otherObjectIndex) {\r\n                initialState.energyTerms[1].affectedObjectPairs[[objectIndex, otherObjectIndex].toString()] = true\r\n            }\r\n        })\r\n    })\r\n\r\n    return useReducer(appReducer, initialState)\r\n}\r\n\r\nexport const AppContext = createContext<{ state: AppState, dispatch: Dispatch<AppAction> } | undefined>(undefined)","import React, { useState, useCallback, useContext, useEffect } from \"react\"\r\nimport { parseExpression, Expression, Constant } from \"tadiff\"\r\nimport { AppContext, AppEnergyTerm } from \"./Context\"\r\n\r\ntype EnergyTermProps = {\r\n    index: number\r\n}\r\n\r\nfunction makeEnergyTerm(expr: Expression, formula: string): AppEnergyTerm {\r\n    return {\r\n        expression: expr,\r\n        expressionFormula: formula,\r\n        affectedObjects: {},\r\n        affectedObjectPairs: {}\r\n    }\r\n}\r\n\r\nfunction AffectedObjectList(props: EnergyTermProps) {\r\n    const { state, dispatch } = useContext(AppContext)!\r\n\r\n    const index = props.index\r\n\r\n    const energyTerm = state.energyTerms[index]\r\n\r\n    return (\r\n        <div>\r\n            {state.objects.map((object, objectIndex) => {\r\n                const isAffected = !!energyTerm.affectedObjects[objectIndex]\r\n\r\n                const onChange = () => dispatch({\r\n                    type: \"updateEnergyTerm\",\r\n                    index: index,\r\n                    term: {\r\n                        ...energyTerm,\r\n                        affectedObjects: {\r\n                            ...energyTerm.affectedObjects,\r\n                            [objectIndex]: !isAffected\r\n                        }\r\n                    }\r\n                })\r\n\r\n                return <input type=\"checkbox\" key={objectIndex} checked={isAffected} onChange={onChange} />\r\n            })}\r\n        </div>\r\n    )\r\n}\r\n\r\nfunction AffectedObjectPairList(props: EnergyTermProps) {\r\n    const { state, dispatch } = useContext(AppContext)!\r\n\r\n    const index = props.index\r\n\r\n    const energyTerm = state.energyTerms[index]\r\n\r\n    return (\r\n        <div>\r\n            {state.objects.map((object, objectIndex) =>\r\n                <div>\r\n                    {state.objects.map((otherObject, otherObjectIndex) => {\r\n                        const pairIndex = [objectIndex, otherObjectIndex].toString()\r\n                        const isAffected = !!energyTerm.affectedObjectPairs[pairIndex]\r\n\r\n                        const onChange = () => dispatch({\r\n                            type: \"updateEnergyTerm\",\r\n                            index: index,\r\n                            term: {\r\n                                ...energyTerm,\r\n                                affectedObjectPairs: {\r\n                                    ...energyTerm.affectedObjectPairs,\r\n                                    [pairIndex]: !isAffected\r\n                                }\r\n                            }\r\n                        })\r\n\r\n                        return <input type=\"checkbox\" key={objectIndex} checked={isAffected} onChange={onChange} />\r\n                    })}\r\n                </div>\r\n            )}\r\n        </div>\r\n    )\r\n}\r\n\r\nfunction EnergyTerm(props: EnergyTermProps) {\r\n    const { state, dispatch } = useContext(AppContext)!\r\n\r\n    const [formula, setFormula] = useState(\"\")\r\n    const [parsed, setParsed] = useState(true)\r\n    const index = props.index\r\n\r\n    const energyTerm = state.energyTerms[index]\r\n\r\n    useEffect(() => {\r\n        if (formula === \"\") {\r\n            setFormula(energyTerm.expressionFormula)\r\n        }\r\n    }, [energyTerm, formula])\r\n\r\n    const parseFormula = useCallback(() => {\r\n        const energyExpression = parseExpression(formula)\r\n        setParsed(true)\r\n        dispatch({ type: \"updateEnergyTerm\", index: index, term: { ...energyTerm, expression: energyExpression, expressionFormula: formula } })\r\n    }, [formula, index, dispatch, energyTerm])\r\n\r\n    const onFormulaChanged = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {\r\n        setFormula(e.target.value)\r\n        setParsed(false)\r\n    }, [])\r\n\r\n    return (\r\n        <div style={{ border: \"2px solid black\", padding: \"4px\", margin: \"4px\" }}>\r\n            <h2>Energy {index}</h2>\r\n            <input type=\"text\" style={{ width: 800, color: parsed ? \"black\" : \"red\" }} onChange={onFormulaChanged} value={formula} />\r\n            <input type=\"button\" value=\"Parse\" onClick={parseFormula} />\r\n\r\n            <h3>Affected objects</h3>\r\n            <AffectedObjectList index={index} />\r\n\r\n            <h3>Affected object pairs</h3>\r\n            <AffectedObjectPairList index={index} />\r\n        </div>\r\n    )\r\n}\r\n\r\nexport default function EnergyTermList() {\r\n    const { state, dispatch } = useContext(AppContext)!\r\n\r\n    const energyTerms = state.energyTerms\r\n\r\n    return (\r\n        <div style={{}}>\r\n            <h1>Energy terms</h1>\r\n            <div>\r\n                {energyTerms.map((term, index) => <EnergyTerm key={index} index={index} />)}\r\n            </div>\r\n            <input type=\"button\" value=\"Add\" onClick={() => dispatch({ type: \"addEnergyTerm\", term: makeEnergyTerm(new Constant(0), \"0\") })} />\r\n            <input type=\"button\" value=\"Remove\" onClick={() => dispatch({ type: \"removeEnergyTerm\" })} />\r\n        </div>\r\n    )\r\n}\r\n","import React, { useContext } from \"react\"\r\nimport { AppContext } from \"./Context\"\r\n\r\nexport function ObjectList() {\r\n    const { state, dispatch } = useContext(AppContext)!\r\n\r\n    return (\r\n        <div>\r\n            <h1>Objects</h1>\r\n            <div>\r\n                {state.objects.map((object, index) => {\r\n                    return (\r\n                        <div style={{ border: \"2px solid black\", padding: \"4px\", margin: \"4px\" }}>\r\n                            <h2>Object {index}</h2>\r\n                        </div>\r\n                    )\r\n                })}\r\n            </div>\r\n            <input type=\"button\" value=\"Add\" onClick={() => dispatch({ type: \"addObject\" })} />\r\n            <input type=\"button\" value=\"Remove\" onClick={() => dispatch({ type: \"removeObject\" })} />\r\n        </div>\r\n    )\r\n}","import React, { useState, useCallback, useRef, useEffect, useContext } from 'react'\n\nimport { SymplecticIntegrator, IntegratorState } from \"./Symplectic\"\n\nimport { getAllDerivatives, getDerivativeForExpression, getAllVariables } from \"tadiff\"\nimport * as e from \"tadiff/expressions\"\n\nimport { AppContext, useAppReducer } from \"./Context\"\nimport EnergyTermList from './EnergyTermList'\nimport { ObjectList } from './ObjectList'\nimport { Tabs, TabPanel, TabList, Tab } from 'react-tabs'\nimport \"react-tabs/style/react-tabs.css\"\n\nconst IntegratorStateCanvas = (props: { integratorState: IntegratorState }) => {\n    const { state } = useContext(AppContext)!\n\n    const canvasRef = useRef<HTMLCanvasElement>(null)\n\n    const [scale, setScale] = useState(200 / state.initialPositionScale)\n    const [offset, setOffset] = useState([0, 0])\n\n    useEffect(() => {\n        if (canvasRef.current) {\n            const canvas = canvasRef.current\n            const ctx = canvas.getContext(\"2d\")\n            if (ctx) {\n                ctx.fillStyle = \"rgb(20, 20, 20)\"\n                ctx.fillRect(0, 0, canvas.width, canvas.height)\n\n                ctx.fillStyle = \"red\"\n                for (const object of props.integratorState.objects) {\n                    const [x, y] = [object.position[0], object.position[1]]\n\n                    const [endX, endY] = [object.position[0] + object.momentum[0], object.position[1] + object.momentum[1]]\n                    ctx.strokeStyle = \"blue\"\n                    ctx.beginPath()\n                    ctx.moveTo(scale * x + canvas.width / 2 + offset[0], scale * y + canvas.height / 2 + offset[1])\n                    ctx.lineTo(scale * endX + canvas.width / 2 + offset[0], scale * endY + canvas.height / 2 + offset[1])\n                    ctx.stroke()\n\n                    ctx.fillRect(scale * x - 2 + canvas.width / 2 + offset[0], scale * y - 2 + canvas.height / 2 + offset[1], 4, 4)\n                }\n\n                ctx.strokeStyle = \"lime\"\n                ctx.beginPath()\n                ctx.moveTo(10, 10)\n                ctx.lineTo(110, 10)\n                ctx.stroke()\n                ctx.fillStyle = \"lime\"\n                ctx.fillText((100 / scale).toFixed(2), 50, 20)\n\n                ctx.fillText(`t: ${props.integratorState.time.toFixed(2)}`, canvas.width - 50, 20)\n            }\n        }\n    }, [props.integratorState, canvasRef, scale, offset])\n\n    const onWheel = useCallback((e: React.WheelEvent<HTMLCanvasElement>) => {\n        console.log(scale)\n        setScale(scale * (1 - 0.1 * Math.sign(e.deltaY)))\n    }, [scale, setScale])\n\n    const [scrolling, setScrolling] = useState(false)\n    const [prevMousePos, setPrevMousePos] = useState([0, 0])\n    const onMouseDown = useCallback((e: React.MouseEvent<HTMLCanvasElement>) => {\n        if (e.button === 0) {\n            setScrolling(true)\n            setPrevMousePos([e.clientX, e.clientY])\n        }\n    }, [setScrolling, setPrevMousePos])\n\n    const onMouseUp = useCallback((e: React.MouseEvent<HTMLCanvasElement>) => {\n        if (e.button === 0) {\n            setScrolling(false)\n        }\n    }, [setScrolling])\n\n    const onMouseMove = useCallback((e: React.MouseEvent<HTMLCanvasElement>) => {\n        if (scrolling) {\n            const delta = [e.clientX - prevMousePos[0], e.clientY - prevMousePos[1]]\n\n            setOffset([offset[0] + delta[0], offset[1] + delta[1]])\n            setPrevMousePos([e.clientX, e.clientY])\n        }\n    }, [scrolling, prevMousePos, setPrevMousePos, offset])\n\n    return <canvas width=\"1000\" height=\"1000\" ref={canvasRef} onWheel={onWheel}\n        onMouseDown={onMouseDown} onMouseMove={onMouseMove} onMouseUp={onMouseUp} />\n}\n\nconst integratorConstants = [\n    { c: 0.2465881872786138277570711850755, d: 0.0833333333333333333333333333333 },\n    { c: 0.6047073875057809013986983841500, d: 0.3977675859548440074217908138861 },\n    { c: -0.4009869039788007481085648931513, d: -0.0393336931446257363828544842332 },\n    { c: 0.0993826583888120379055906478517, d: 0.0582327738564483956277303370138 },\n    { c: -0.4009869039788007481085648931513, d: 0.0582327738564483956277303370138 },\n    { c: 0.6047073875057809013986983841500, d: -0.0393336931446257363828544842332 },\n    { c: 0.2465881872786138277570711850755, d: 0.3977675859548440074217908138861 },\n    { c: 0.0000000000000000000000000000000, d: 0.0833333333333333333333333333333 },\n]\n\nfunction makeSingleContext(position: number[], momentum: number[], dimensions: number): e.EvaluationContext {\n    const context: e.EvaluationContext = {\n        variableValues: {}\n    }\n\n    for (let dim = 0; dim < dimensions; dim++) {\n        context.variableValues[\"p\" + dim.toString()] = momentum[dim]\n        context.variableValues[\"q\" + dim.toString()] = position[dim]\n    }\n\n    return context\n}\n\nfunction makePairContext(position: number[], momentum: number[], otherPosition: number[], otherMomentum: number[], dimensions: number): e.EvaluationContext {\n    const context = makeSingleContext(position, momentum, dimensions)\n\n    for (let dim = 0; dim < dimensions; dim++) {\n        context.variableValues[\"p\" + dim.toString() + \"_b\"] = otherMomentum[dim]\n        context.variableValues[\"q\" + dim.toString() + \"_b\"] = otherPosition[dim]\n    }\n\n    return context\n}\n\nconst stepSize = 0.02\nconst speed = 1\n\nconst IntegratorComponent = () => {\n    const { state, dispatch } = useContext(AppContext)!\n\n    const { initialPositionScale, initialMomentumScale } = state\n\n    const [integratorState, setIntegratorState] = useState<IntegratorState | null>(null)\n\n    const [integrator, setIntegrator] = useState<SymplecticIntegrator | null>(null)\n\n    const calcNextState = useCallback(() => {\n        if (integrator && integratorState) {\n            const newState = integrator.iterate(integratorState, stepSize)\n            setIntegratorState(newState)\n        }\n    }, [integratorState, setIntegratorState, integrator])\n\n    useEffect(() => {\n        const interval = setInterval(calcNextState, 1000 * stepSize / speed)\n        return () => clearInterval(interval)\n    }, [calcNextState])\n\n    const simulate = useCallback(() => {\n        const energyTerms = state.energyTerms\n\n        const gradsPosition: e.Expression[][] = []\n        const gradsMomentum: e.Expression[][] = []\n\n        for (const energyTerm of energyTerms) {\n            const termVariables = getAllVariables(energyTerm.expression)\n\n            const energyTermGradsPosition = []\n            const energyTermGradsMomentum = []\n\n            for (let dim = 0; dim < state.dimensions; dim++) {\n                const gradPosition = getDerivativeForExpression(termVariables[\"q\" + dim.toString()], getAllDerivatives(energyTerm.expression, new e.Constant(1)))\n                const gradMomentum = getDerivativeForExpression(termVariables[\"p\" + dim.toString()], getAllDerivatives(energyTerm.expression, new e.Constant(1)))\n\n                energyTermGradsPosition.push(gradPosition)\n                energyTermGradsMomentum.push(gradMomentum)\n            }\n\n            gradsPosition.push(energyTermGradsPosition)\n            gradsMomentum.push(energyTermGradsMomentum)\n        }\n\n        const getGradForObject = (objectIndex: number, position: number[], momentum: number[], integratorState: IntegratorState) => {\n            const evaluationContext = makeSingleContext(position, momentum, state.dimensions)\n\n            const gradPosition: number[] = []\n            const gradMomentum: number[] = []\n\n            for (let dim = 0; dim < state.dimensions; dim++) {\n                gradPosition.push(0)\n                gradMomentum.push(0)\n            }\n\n            state.energyTerms.forEach((energyTerm, energyTermIndex) => {\n                if (energyTerm.affectedObjects[objectIndex]) {\n                    for (let dim = 0; dim < state.dimensions; dim++) {\n                        gradPosition[dim] += gradsPosition[energyTermIndex][dim].evaluate(evaluationContext)\n                        gradMomentum[dim] += gradsMomentum[energyTermIndex][dim].evaluate(evaluationContext)\n                    }\n                }\n\n                integratorState.objects.forEach((_, otherObjectIndex) => {\n                    if (energyTerm.affectedObjectPairs[[objectIndex, otherObjectIndex].toString()]) {\n                        const otherObject = integratorState.objects[otherObjectIndex]\n                        const pairContext = makePairContext(position, momentum, otherObject.position, otherObject.momentum, state.dimensions)\n\n                        for (let dim = 0; dim < state.dimensions; dim++) {\n                            gradPosition[dim] += gradsPosition[energyTermIndex][dim].evaluate(pairContext)\n                            gradMomentum[dim] += gradsMomentum[energyTermIndex][dim].evaluate(pairContext)\n                        }\n                    }\n                })\n            })\n\n            return {\n                gradPosition: gradPosition,\n                gradMomentum: gradMomentum,\n            }\n        }\n\n        const initialIntegratorState: IntegratorState = {\n            time: 0,\n            objects: []\n        }\n\n        state.objects.forEach((object, objectIndex) => {\n            initialIntegratorState.objects.push({\n                position: [Math.random() * initialPositionScale - initialPositionScale / 2, Math.random() * initialPositionScale - initialPositionScale / 2],\n                momentum: [Math.random() * initialMomentumScale - initialMomentumScale / 2, Math.random() * initialMomentumScale - initialMomentumScale / 2],\n            })\n        })\n\n        setIntegratorState(initialIntegratorState)\n        setIntegrator(new SymplecticIntegrator(integratorConstants, getGradForObject))\n    }, [state.energyTerms, state.objects, state.dimensions, initialPositionScale, initialMomentumScale])\n\n    return (\n        <>\n            <input type=\"button\" value=\"Simulate\" onClick={simulate} />\n\n            <div>\n                <label>Initial position scale: </label>\n                <input type=\"text\" onChange={e => {\n                    const value = parseFloat(e.target.value)\n                    console.log(value)\n                    if (!isNaN(value)) {\n                        dispatch({\n                            type: \"setInitialScales\",\n                            positionScale: value,\n                            momentumScale: initialMomentumScale\n                        })\n                    }\n                }} defaultValue={initialPositionScale.toString()} />\n            </div>\n            <div>\n                <label>Initial momentum scale: </label>\n                <input type=\"text\" onChange={e => {\n                    const value = parseFloat(e.target.value)\n                    if (!isNaN(value)) {\n                        dispatch({\n                            type: \"setInitialScales\",\n                            positionScale: initialPositionScale,\n                            momentumScale: value\n                        })\n                    }\n                }} defaultValue={initialMomentumScale.toString()} />\n            </div>\n\n            {integratorState && (<>\n                <IntegratorStateCanvas integratorState={integratorState} />\n            </>)}\n        </>\n    )\n}\n\nconst App = () => {\n    const [state, dispatch] = useAppReducer()\n\n    return (\n        <AppContext.Provider value={{ state: state, dispatch: dispatch }}>\n            <Tabs>\n                <TabList>\n                    <Tab>Simulation</Tab>\n                    <Tab>Objects</Tab>\n                    <Tab>Energy Terms</Tab>\n                </TabList>\n                <TabPanel><IntegratorComponent /></TabPanel>\n                <TabPanel><ObjectList /></TabPanel>\n                <TabPanel><EnergyTermList /></TabPanel>\n            </Tabs>\n        </AppContext.Provider >\n    )\n}\n\nexport default App","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === 'localhost' ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === '[::1]' ||\n    // 127.0.0.1/8 is considered localhost for IPv4.\n    window.location.hostname.match(\n      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\n    )\n);\n\ntype Config = {\n  onSuccess?: (registration: ServiceWorkerRegistration) => void;\n  onUpdate?: (registration: ServiceWorkerRegistration) => void;\n};\n\nexport function register(config?: Config) {\n  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL(\n      (process as { env: { [key: string]: string } }).env.PUBLIC_URL,\n      window.location.href\n    );\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return;\n    }\n\n    window.addEventListener('load', () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config);\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.log(\n            'This web app is being served cache-first by a service ' +\n              'worker. To learn more, visit https://bit.ly/CRA-PWA'\n          );\n        });\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config);\n      }\n    });\n  }\n}\n\nfunction registerValidSW(swUrl: string, config?: Config) {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then(registration => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing;\n        if (installingWorker == null) {\n          return;\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === 'installed') {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n              console.log(\n                'New content is available and will be used when all ' +\n                  'tabs for this page are closed. See https://bit.ly/CRA-PWA.'\n              );\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration);\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n              console.log('Content is cached for offline use.');\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration);\n              }\n            }\n          }\n        };\n      };\n    })\n    .catch(error => {\n      console.error('Error during service worker registration:', error);\n    });\n}\n\nfunction checkValidServiceWorker(swUrl: string, config?: Config) {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl)\n    .then(response => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get('content-type');\n      if (\n        response.status === 404 ||\n        (contentType != null && contentType.indexOf('javascript') === -1)\n      ) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then(registration => {\n          registration.unregister().then(() => {\n            window.location.reload();\n          });\n        });\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config);\n      }\n    })\n    .catch(() => {\n      console.log(\n        'No internet connection found. App is running in offline mode.'\n      );\n    });\n}\n\nexport function unregister() {\n  if ('serviceWorker' in navigator) {\n    navigator.serviceWorker.ready.then(registration => {\n      registration.unregister();\n    });\n  }\n}\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport App from './App';\nimport * as serviceWorker from './serviceWorker';\n\nReactDOM.render(<App />, document.getElementById('root'));\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\nserviceWorker.register();\n"],"sourceRoot":""}